"use strict";(self.webpackChunkhub=self.webpackChunkhub||[]).push([[6682],{26682:(e,o,n)=>{n.r(o),n.d(o,{default:()=>C});var s=n(9950),t=n(93498),c=n(52111),a=n(91460),i=n(41418),r=n(82570),l=n(75818),u=n(99503),d=n(82677),h=n(78711),g=n(70641),m=n(35401),S=(n(4371),n(44414));const C=()=>{const{coachId:e="grace"}=(0,t.g)(),o=(0,t.Zp)(),n=(0,r.Fd)(e),[C,f]=((0,l.Ec)(e),(0,s.useState)(!1)),[v,y]=(0,s.useState)({}),[p,b]=(0,s.useState)(new Uint8Array(128)),[A,x]=(0,s.useState)(""),[k,j]=(0,s.useState)(""),[w,E]=(0,s.useState)(!1),[U,R]=(0,s.useState)(null),[T,N]=(0,s.useState)(null),[D,z]=(0,s.useState)(""),[F,M]=(0,s.useState)(null),[P,L]=(0,s.useState)(!1),[q,H]=(0,s.useState)("idle"),[I,V]=(0,s.useState)({}),[B,O]=(0,s.useState)(!1),[K,_]=(0,s.useState)(!1),[J,Y]=(0,s.useState)([]),[Z,G]=(0,s.useState)(!1),Q=(0,s.useRef)(null),W=(0,s.useRef)(null),X=(0,s.useRef)(null),$=(0,s.useRef)(new Audio),ee=(0,s.useRef)([]),oe=(0,s.useRef)(!1),ne=(0,s.useRef)(!1);(0,s.useEffect)((()=>($.current.onended=()=>{console.log("[CoachSession] Audio ended, playing next"),O(!1),H("idle"),console.log("[CoachSession] Animation state set to: idle"),setTimeout((()=>se()),100)},()=>{W.current&&"closed"!==W.current.state&&W.current.close()})),[]),(0,s.useEffect)((()=>((async()=>{try{console.log("[CoachSession] Requesting camera and microphone permissions...");const e=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});e.getVideoTracks().forEach((e=>{e.addEventListener("ended",(()=>{console.log("[CoachSession] Video track ended")}))})),M(e),L(!0)}catch(U){console.error("[CoachSession] Error accessing media devices:",U),R("Please allow camera and microphone access for the coach session")}})(),()=>{F&&F.getTracks().forEach((e=>e.stop()))})),[]),(0,s.useEffect)((()=>{(async()=>{Q.current||(console.log("[CoachSession] Initializing HybridVoiceService..."),Q.current=new a.Y,Q.current.onAudio((e=>{console.log("[CoachSession] Audio received:",e.size),O(!0),H("talking"),console.log("[CoachSession] Animation state set to: talking"),ee.current.push(e),oe.current||se()})),Q.current.onMessage((e=>{var o;console.log("[CoachSession] Message received:",e);const n="string"===typeof e?e:(null===e||void 0===e||null===(o=e.message)||void 0===o?void 0:o.content)||(null===e||void 0===e?void 0:e.content)||JSON.stringify(e);var s,t;if(n&&n.trim()&&(Y((e=>[...e,{role:"assistant",content:n}])),x(n),null!==e&&void 0!==e&&null!==(s=e.models)&&void 0!==s&&null!==(t=s.prosody)&&void 0!==t&&t.scores)){const o=e.models.prosody.scores,n=Object.entries(o).map((e=>{let[o,n]=e;return{name:o.charAt(0).toUpperCase()+o.slice(1),score:n}})),s=(0,h.R)(n);V(s)}})),Q.current.onAssistantEnd((()=>{console.log("[CoachSession] Assistant ended"),O(!1),H("idle"),console.log("[CoachSession] Animation state set to: idle")})),Q.current.onUserMessage((e=>{console.log("[CoachSession] User message:",e),Y((o=>[...o,{role:"user",content:e}])),j(e)})),Q.current.onError((e=>{console.error("[CoachSession] Error:",e),R(e.message)})),console.log("[CoachSession] HybridVoiceService initialized successfully"))})()}),[]);const se=()=>{if(0===ee.current.length)return oe.current=!1,O(!1),H("idle"),void console.log("[CoachSession] Animation state set to: idle");console.log("[CoachSession] Playing audio from queue, queue length:",ee.current.length),oe.current=!0;const e=ee.current.shift(),o=URL.createObjectURL(e);if($.current.src=o,!ne.current)try{if(!W.current||"closed"===W.current.state){const e=window.AudioContext||window.webkitAudioContext;W.current=new e({sampleRate:48e3}),console.log("[CoachSession] Created new AudioContext")}"suspended"===W.current.state&&(W.current.resume(),console.log("[CoachSession] Resumed AudioContext"));const e=W.current.createAnalyser();e.fftSize=256;W.current.createMediaElementSource($.current).connect(e),e.connect(W.current.destination),X.current=e,ne.current=!0,console.log("[CoachSession] Audio analyzer setup complete")}catch(U){console.error("[CoachSession] Error setting up audio analyzer:",U)}$.current.play().then((()=>{console.log("[CoachSession] Audio playing successfully"),O(!0),H("talking"),console.log("[CoachSession] Animation state set to: talking")})).catch((e=>{console.error("[CoachSession] Error playing audio:",e),oe.current=!1,O(!1),H("idle"),console.log("[CoachSession] Animation state set to: idle"),setTimeout((()=>se()),100)})),$.current.onended=()=>{console.log("[CoachSession] Audio playback ended"),URL.revokeObjectURL(o),oe.current=!1,O(!1),H("idle"),console.log("[CoachSession] Animation state set to: idle"),setTimeout((()=>se()),100)}};(0,s.useEffect)((()=>{if(!B||!X.current)return void b(new Uint8Array);console.log("[CoachSession] Starting audio analysis for lip sync");const e=X.current,o=e.frequencyBinCount,n=new Uint8Array(o);let s,t=0;const c=()=>{e.getByteFrequencyData(n),b(new Uint8Array(n));const o=Date.now();if(o-t>1e3){const e=n.reduce(((e,o)=>e+o),0)/n.length;console.log("[CoachSession] Audio analysis - Avg level:",e.toFixed(2),"Max:",Math.max(...n)),t=o}s=requestAnimationFrame(c)};return c(),()=>{s&&cancelAnimationFrame(s),console.log("[CoachSession] Stopping audio analysis for lip sync"),b(new Uint8Array)}}),[B]);return(0,s.useEffect)((()=>{const e=(0,m.y4)();e.apiKey&&e.secretKey||(G(!0),R("Hume credentials not configured. Please use the emergency credentials form."))}),[]),(0,S.jsxs)("div",{className:"coach-session",children:[(0,S.jsx)(u.MediaDebug,{}),(0,S.jsxs)("div",{className:"coach-header",children:[(0,S.jsxs)("h1",{children:["Coach Session: ",(null===n||void 0===n?void 0:n.name)||"Unknown Coach"]}),(0,S.jsx)("button",{onClick:()=>o("/coaches"),className:"back-button",children:"Back to Coaches"})]}),(0,S.jsxs)("div",{className:"session-container",children:[Z&&(0,S.jsx)(g.default,{}),(0,S.jsxs)("div",{className:"coach-avatar-scene",style:{backgroundColor:"#1a1a1a",backgroundImage:null!==n&&void 0!==n&&n.venue?"url(/Venues/".concat(n.venue,")"):"none",backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat"},children:[K&&(0,S.jsxs)(c.Hl,{camera:{position:[0,.8,3],fov:35},children:[(0,S.jsx)("ambientLight",{intensity:.8}),(0,S.jsx)("directionalLight",{position:[0,1,2],intensity:1.2}),(0,S.jsx)(s.Suspense,{fallback:null,children:(0,S.jsx)(i.PresenceAvatar,{avatarUrl:(null===n||void 0===n?void 0:n.avatar)||"/avatars/coach_grace.glb",position:[0,-1.8,0],scale:1.3,animationName:q,emotionalBlendshapes:I,audioData:p})})]}),!K&&n&&(0,S.jsxs)("div",{className:"coach-preview",style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%",color:"white",textAlign:"center",padding:"2rem"},children:[(0,S.jsx)("h2",{children:n.name}),(0,S.jsx)("p",{children:n.description}),(0,S.jsx)("p",{style:{marginTop:"2rem",opacity:.8},children:'Click "Start Coach Session" to begin'})]})]}),!1,(0,S.jsxs)("div",{className:"session-controls",children:[K?(0,S.jsx)("button",{onClick:async()=>{try{Q.current&&(await Q.current.disconnect(),_(!1),Y([]))}catch(e){console.error("[CoachSession] Disconnect error:",e)}},className:"control-button end-button",children:"End Session (Stop Billing)"}):(0,S.jsx)("button",{onClick:async()=>{try{if(E(!0),R(null),Q.current){const e=(null===n||void 0===n?void 0:n.humeConfigId)||"bfd6db39-f0ea-46c3-a64b-e902d8cec212";console.log("[CoachSession] Connecting to HybridVoiceService..."),Q.current.connect(e).then((()=>{console.log("[CoachSession] Connected to Hume"),_(!0),E(!1),setTimeout((()=>{console.log("[CoachSession] TEST: Forcing talking animation state"),H("talking"),O(!0),setTimeout((()=>{console.log("[CoachSession] TEST: Resetting to idle animation state"),H("idle"),O(!1)}),5e3)}),2e3)})).catch((e=>{console.error("[CoachSession] Connection error:",e),R(e instanceof Error?e.message:"Failed to connect to coach")}))}}catch(e){console.error("[CoachSession] Connection error:",e),R(e instanceof Error?e.message:"Failed to connect to coach")}finally{E(!1)}},disabled:!P||w,className:"control-button start-button",children:w?"Connecting...":"Start Coach Session"}),(0,S.jsxs)("div",{className:"connection-status",children:["Status: ",K?"\ud83d\udfe2 Connected (Using API Credits)":"\u26ab Disconnected"]})]})]}),P&&F&&(0,S.jsx)(d.UserAvatarPiP,{avatarUrl:"/avatars/user_avatar.glb",position:"bottom-right",size:"medium",trackingData:T,enableOwnTracking:!0,cameraStream:F})]})}}}]);