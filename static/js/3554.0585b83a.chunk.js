"use strict";(self.webpackChunkhub=self.webpackChunkhub||[]).push([[3554],{23554:(e,t,o)=>{o.r(t),o.d(t,{default:()=>g});var n=o(89379),r=o(9950),i=o(52111),s=o(68057),a=o(53986);const h=["happy","sad","angry","surprised","neutral"],u=e=>{const[t,o]=(0,r.useState)({}),i=(0,r.useCallback)((e=>{const t={};try{var o,n,r,i,s,a;null!==(o=e.face)&&void 0!==o&&null!==(n=o.predictions)&&void 0!==n&&null!==(r=n[0])&&void 0!==r&&r.emotions?e.face.predictions[0].emotions.forEach((e=>{t[e.name]=e.score})):null!==(i=e.face)&&void 0!==i&&i.emotions?Object.assign(t,e.face.emotions):null!==(s=e.predictions)&&void 0!==s&&null!==(a=s[0])&&void 0!==a&&a.emotions?e.predictions[0].emotions.forEach((e=>{t[e.name]=e.score})):e.emotions&&Object.assign(t,e.emotions)}catch(h){console.error("Error extracting emotions:",h)}return t}),[]),s=(0,r.useCallback)((e=>{o((t=>(0,n.A)((0,n.A)((0,n.A)({},t),{},{mouthClose:0,mouthOpen:0,mouthPucker:0,mouthFunnel:0},"AA"===e&&{jawOpen:.7,mouthFunnel:.3}),"M"===e&&{mouthClose:1,jawOpen:.1})))}),[]),u=(0,r.useCallback)((()=>{o({mouthClose:.5,mouthSmileLeft:0,mouthSmileRight:0})}),[]);return(0,r.useEffect)((()=>{if(e)try{const t=(e=>{const{happy:t=0,sad:o=0,angry:n=0,surprised:r=0,neutral:i=0}=e,s=((0,a.A)(e,h),{mouthClose:.5,mouthSmileLeft:0,mouthSmileRight:0,mouthFrownLeft:0,mouthFrownRight:0,mouthPressLeft:0,mouthPressRight:0,mouthLowerDownLeft:0,mouthLowerDownRight:0,mouthUpperUpLeft:0,mouthUpperUpRight:0,mouthOpen:0,mouthPucker:0,mouthFunnel:0,mouthRollLower:0,mouthRollUpper:0,mouthShrugLower:0,mouthShrugUpper:0,eyeBlinkLeft:0,eyeBlinkRight:0,eyeSquintLeft:0,eyeSquintRight:0,eyeWideLeft:0,eyeWideRight:0,eyeLookInLeft:0,eyeLookInRight:0,eyeLookOutLeft:0,eyeLookOutRight:0,eyeLookUpLeft:0,eyeLookUpRight:0,eyeLookDownLeft:0,eyeLookDownRight:0,browDownLeft:0,browDownRight:0,browInnerUp:0,browOuterUpLeft:0,browOuterUpRight:0,cheekPuff:0,cheekSquintLeft:0,cheekSquintRight:0,noseSneerLeft:0,noseSneerRight:0,tongueOut:0,jawOpen:0,jawForward:0,jawLeft:0,jawRight:0});if(t>.3&&(s.mouthSmileLeft=t,s.mouthSmileRight=t,s.cheekSquintLeft=.8*t,s.cheekSquintRight=.8*t,s.eyeSquintLeft=.5*t,s.eyeSquintRight=.5*t),o>.3&&(s.mouthFrownLeft=.7*o,s.mouthFrownRight=.7*o,s.browInnerUp=.5*o,s.browOuterUpLeft=.3*o,s.browOuterUpRight=.3*o),n>.3&&(s.browDownLeft=.8*n,s.browDownRight=.8*n,s.noseSneerLeft=.5*n,s.noseSneerRight=.5*n,s.mouthPressLeft=.6*n,s.mouthPressRight=.6*n),r>.3&&(s.browInnerUp=Math.max(s.browInnerUp||0,.8*r),s.browOuterUpLeft=Math.max(s.browOuterUpLeft||0,.8*r),s.browOuterUpRight=Math.max(s.browOuterUpRight||0,.8*r),s.eyeWideLeft=.9*r,s.eyeWideRight=.9*r,s.jawOpen=.5*r),e.phoneme){const t=e.phoneme.toString().toUpperCase();s.mouthClose=0,s.mouthOpen=0,s.mouthPucker=0,s.mouthFunnel=0,["AA","AE","AH","AY","AW"].includes(t)?(s.jawOpen=.7,s.mouthFunnel=.3):["EE","IH","IY"].includes(t)?(s.mouthSmileLeft=.8,s.mouthSmileRight=.8,s.jawOpen=.3):["OO","UW","UH"].includes(t)?(s.mouthPucker=.7,s.jawOpen=.4):["M","B","P"].includes(t)?(s.mouthClose=1,s.jawOpen=.1):["F","V"].includes(t)?(s.mouthPressLeft=.5,s.mouthPressRight=.5):["TH","DH"].includes(t)&&(s.tongueOut=.5,s.jawOpen=.4)}return s})(i(e));o((e=>(0,n.A)((0,n.A)({},e),t)))}catch(t){console.error("Error processing emotion data:",t)}}),[e,i]),{blendShapes:t,applyPhoneme:s,resetBlendShapes:u}};var l=o(42342),c=o(44414);const m=(0,r.lazy)((()=>o.e(177).then(o.bind(o,90177)))),p=()=>(0,c.jsxs)("mesh",{children:[(0,c.jsx)("boxGeometry",{args:[1,1,1]}),(0,c.jsx)("meshStandardMaterial",{color:"gray"})]}),f={mouthClose:.5,mouthFunnel:0,mouthPucker:0,mouthLeft:0,mouthRight:0,mouthSmileLeft:0,mouthSmileRight:0,mouthFrownLeft:0,mouthFrownRight:0,mouthStretchLeft:0,mouthStretchRight:0,mouthDimpleLeft:0,mouthDimpleRight:0,mouthRollLower:0,mouthRollUpper:0,mouthShrugLower:0,mouthShrugUpper:0,mouthPressLeft:0,mouthPressRight:0,mouthLowerDownLeft:0,mouthLowerDownRight:0,mouthUpperUpLeft:0,mouthUpperUpRight:0,mouthOpen:0,jawOpen:0,jawForward:0,jawLeft:0,jawRight:0,eyeBlinkLeft:0,eyeBlinkRight:0,eyeSquintLeft:0,eyeSquintRight:0,eyeWideLeft:0,eyeWideRight:0,eyeLookInLeft:0,eyeLookInRight:0,eyeLookOutLeft:0,eyeLookOutRight:0,eyeLookUpLeft:0,eyeLookUpRight:0,eyeLookDownLeft:0,eyeLookDownRight:0,browDownLeft:0,browDownRight:0,browInnerUp:0,browOuterUpLeft:0,browOuterUpRight:0,cheekPuff:0,cheekSquintLeft:0,cheekSquintRight:0,noseSneerLeft:0,noseSneerRight:0,tongueOut:0,chestBreathing:0},d=e=>{const t=(0,n.A)({},f);if(!e)return t;try{var o;const{predictions:n}=e;if(!n||null===(o=n[0])||void 0===o||!o.emotions)return t;const r={happy:0,sad:0,surprise:0,fear:0,anger:0,disgust:0,neutral:1},i=n[0].emotions||r;i.happy>.3&&(t.mouthSmileLeft=Math.min(1,1.5*i.happy),t.mouthSmileRight=Math.min(1,1.5*i.happy),t.eyeSquintLeft=Math.min(.5,.7*i.happy),t.eyeSquintRight=Math.min(.5,.7*i.happy)),i.sad>.3&&(t.mouthFrownLeft=Math.min(1,1.5*i.sad),t.mouthFrownRight=Math.min(1,1.5*i.sad),t.browInnerUp=Math.min(1,1.2*i.sad)),i.anger>.3&&(t.browDownLeft=Math.min(1,1.2*i.anger),t.browDownRight=Math.min(1,1.2*i.anger),t.mouthFrownLeft=Math.min(1,1.5*i.anger),t.mouthFrownRight=Math.min(1,1.5*i.anger),t.noseSneerLeft=Math.min(1,1.2*i.anger),t.noseSneerRight=Math.min(1,1.2*i.anger)),i.surprise>.3&&(t.eyeWideLeft=Math.min(1,1.5*i.surprise),t.eyeWideRight=Math.min(1,1.5*i.surprise),t.browInnerUp=Math.min(1,1.2*i.surprise),t.jawOpen=Math.min(.7,.7*i.surprise))}catch(r){const e=r instanceof Error?r.message:"Error processing emotion data";return console.error("Error processing emotion data:",e),(0,n.A)({},f)}return t},g=e=>{let{emotionData:t,onAvatarLoaded:o,onEmotionDataProcessed:a,avatar:h}=e;const[f,g]=(0,r.useState)(null),[L,w]=(0,r.useState)({eyeBlinkLeft:0,eyeBlinkRight:0,mouthSmileLeft:.1,browInnerUp:.05,chestBreathing:0}),[y,R]=(0,r.useState)({breathing:0,blinkTimer:0,nextBlink:3}),[k,b]=(0,r.useState)(!1),[S,O]=(0,r.useState)(""),{applyPhoneme:U,resetBlendShapes:j}=u(t),v=d(t),x=(0,r.useMemo)((()=>(0,n.A)((0,n.A)((0,n.A)({},v),L),{},{eyeBlinkLeft:v.eyeBlinkLeft||L.eyeBlinkLeft||0,eyeBlinkRight:v.eyeBlinkRight||L.eyeBlinkRight||0})),[v,L]);(0,r.useEffect)((()=>{a&&a(x)}),[x,a]),(0,r.useEffect)((()=>{null!==t&&void 0!==t&&t.phoneme?U(t.phoneme):j()}),[null===t||void 0===t?void 0:t.phoneme,U,j]);const A=(0,r.useRef)(null),M=(0,r.useCallback)((e=>{e&&(A.current=e,o&&o(e))}),[o]),E=(0,r.useRef)(null),P=(0,r.useRef)("");(0,r.useEffect)((()=>{P.current=S}),[S]);const B=(0,r.useRef)(),F=(0,r.useRef)(0);(0,r.useEffect)((()=>{const e=setInterval((()=>{R((e=>{const t=Date.now()/1e3,o=.02*Math.sin(.5*t);let r=e.blinkTimer+.016,i=e.nextBlink,s=0;return r>=i?(s=1,r=0,i=2+4*Math.random()):r<.15&&(s=Math.sin(r/.15*Math.PI)),w((e=>(0,n.A)((0,n.A)({},e),{},{eyeBlinkLeft:s,eyeBlinkRight:s,chestBreathing:o}))),{breathing:o,blinkTimer:r,nextBlink:i}}))}),16);return()=>clearInterval(e)}),[]),(0,r.useEffect)((()=>{const e=()=>{try{const t="m3KaINwHsH55rJNO6zr2kIEAWvOimYeLTon3OriOXWJeCxCl";if(!t)return console.error("No Hume API key found. Please set REACT_APP_HUME_API_KEY or save it in settings."),void O("No Hume API key configured");const o="wss://api.hume.ai/v0/stream/models?apiKey=".concat(t);E.current=new WebSocket(o),E.current.onopen=()=>{var e;console.log("Connected to Hume WebSocket"),b(!0),O("");null===(e=E.current)||void 0===e||e.send(JSON.stringify({data:{models:{face:{}},data:""}}))},E.current.onmessage=e=>{try{const t=JSON.parse(e.data);if(t.face){const e=d(t.face);w(e)}}catch(t){console.error("Error processing WebSocket message:",t)}},E.current.onerror=e=>{console.error("WebSocket error:",e),O("WebSocket connection error"),b(!1)},E.current.onclose=t=>{if(console.log("WebSocket connection closed",t.code,t.reason),b(!1),1e3!==t.code){const e="WebSocket closed with code ".concat(t.code,": ").concat(t.reason||"Unknown reason");O(e)}setTimeout(e,3e3)}}catch(S){const t=S instanceof Error?S.message:"Failed to connect to Hume EVI";console.error("Error setting up WebSocket:",t),O(t),b(!1)}};return e(),()=>{E.current&&E.current.close(),B.current&&cancelAnimationFrame(B.current)}}),[]),(0,r.useEffect)((()=>{let e=0;const t=o=>{if(o-F.current>33){F.current=o,e++;const t=.5*Math.sin(.1*e)+.5;w((e=>(0,n.A)((0,n.A)({},e),{},{jawOpen:Math.max(.1,.5*t),mouthClose:1-.8*t})))}B.current=requestAnimationFrame(t)};return B.current=requestAnimationFrame(t),()=>{B.current&&cancelAnimationFrame(B.current)}}),[]);const I=(()=>{if(null!==h&&void 0!==h&&h.modelUrl)return h.modelUrl;const e=localStorage.getItem("rpm_avatars");if(e){const t=JSON.parse(e);if(t.length>0)return t[0].url}return"https://models.readyplayer.me/64c3f39b6db681b862c7e479.glb"})();return(0,c.jsxs)("div",{style:{width:"100%",height:"100vh",display:"flex",flexDirection:"column"},children:[(0,c.jsxs)("div",{style:{padding:"1rem",background:"#f0f0f0"},children:[(0,c.jsx)("h2",{children:"RPM Avatar with Hume Integration"}),(0,c.jsxs)("div",{style:{display:"flex",gap:"1rem",alignItems:"center"},children:[(0,c.jsx)("span",{children:"Status: "}),(0,c.jsx)("span",{style:{color:k?"green":"red",fontWeight:"bold"},children:k?"\ud83d\udfe2 Connected to Hume":"\ud83d\udd34 Not Connected"}),S&&(0,c.jsx)("span",{style:{color:"red",marginLeft:"1rem"},children:S})]}),(0,c.jsx)("div",{style:{marginTop:"0.5rem",fontSize:"0.9rem",color:"#666"},children:!k&&"Avatar will show idle animations only. Connect to Hume for full emotion support."})]}),(0,c.jsx)("div",{style:{flex:1,position:"relative"},children:(0,c.jsxs)(i.Hl,{camera:{position:[0,1.6,2.5],fov:45,near:.1,far:100},style:{background:"#f0f0f0"},children:[(0,c.jsx)("ambientLight",{intensity:.5}),(0,c.jsx)("directionalLight",{position:[0,5,5],intensity:.5}),(0,c.jsx)(r.Suspense,{fallback:(0,c.jsx)(p,{}),children:(0,c.jsx)(m,{ref:M,avatarUrl:I,blendShapes:x,position:[0,-.5,0],scale:[1,1,1],onLoaded:()=>{console.log("Avatar loaded"),o&&o(A.current)},onModelLoaded:e=>{console.log("Avatar model loaded:",e),console.log("Current blend shapes:",x)}})}),(0,c.jsx)(l.E,{position:[0,2.5,0],children:(0,c.jsxs)("div",{style:{background:"rgba(0,0,0,0.7)",color:"white",padding:"10px",borderRadius:"5px",fontSize:"12px",whiteSpace:"pre"},children:["Avatar URL: ",I.split("/").pop(),"\n","Breathing: ",y.breathing.toFixed(2),"\n","Blink Timer: ",y.blinkTimer.toFixed(2),"\n","Eye Blink: ",(x.eyeBlinkLeft||0).toFixed(2)]})}),(0,c.jsx)(s.N,{enablePan:!1,enableZoom:!1,enableRotate:!1,autoRotate:!1,target:[0,1.2,0]})]})})]})}}}]);