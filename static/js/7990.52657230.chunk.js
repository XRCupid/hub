"use strict";(self.webpackChunkhub=self.webpackChunkhub||[]).push([[7990],{67990:(e,t,n)=>{n.r(t),n.d(t,{PresenceAvatarWithGender:()=>L});var r=n(65043),a=n(29408),o=n(79183),i=n(81597),c=n(5355),u=n(52652),l=n(70579);const s={browInnerUp:{target:"browInnerUp",amplify:1.5},browDownLeft:{target:"browDownLeft",amplify:1.8},browDownRight:{target:"browDownRight",amplify:1.8},browOuterUpLeft:{target:"browOuterUpLeft",amplify:1.5},browOuterUpRight:{target:"browOuterUpRight",amplify:1.5},mouthSmileLeft:{target:"mouthSmileLeft",amplify:2.5},mouthSmileRight:{target:"mouthSmileRight",amplify:2.5},mouthFrownLeft:{target:"mouthFrownLeft",amplify:2.2},mouthFrownRight:{target:"mouthFrownRight",amplify:2.2},mouthOpen:{target:"mouthOpen",amplify:1},mouthPucker:{target:"mouthPucker",amplify:1.8},mouthLeft:{target:"mouthLeft",amplify:1.5},mouthRight:{target:"mouthRight",amplify:1.5},eyeSquintLeft:{target:"eyeSquintLeft",amplify:1.4},eyeSquintRight:{target:"eyeSquintRight",amplify:1.4},eyeWideLeft:{target:"eyeWideLeft",amplify:1.2},eyeWideRight:{target:"eyeWideRight",amplify:1.2},cheekPuff:{target:"cheekPuff",amplify:1.5},cheekSquintLeft:{target:"cheekSquintLeft",amplify:1.3},cheekSquintRight:{target:"cheekSquintRight",amplify:1.3},noseSneerLeft:{target:"noseSneerLeft",amplify:1.5},noseSneerRight:{target:"noseSneerRight",amplify:1.5},jawOpen:{target:"jawOpen",amplify:1},jawLeft:{target:"jawLeft",amplify:1.2},jawRight:{target:"jawRight",amplify:1.2}},h={joy:["mouthSmileLeft","mouthSmileRight","cheekSquintLeft","cheekSquintRight"],sadness:["mouthFrownLeft","mouthFrownRight","browDownLeft","browDownRight"],anger:["browDownLeft","browDownRight","noseSneerLeft","noseSneerRight"],fear:["eyeWideLeft","eyeWideRight","browInnerUp","mouthOpen"],surprise:["eyeWideLeft","eyeWideRight","browOuterUpLeft","browOuterUpRight","mouthOpen"],disgust:["noseSneerLeft","noseSneerRight","mouthFrownLeft","mouthFrownRight"],contempt:["mouthLeft","mouthRight","eyeSquintLeft","eyeSquintRight"]},m={min:-.5,max:.5},g={min:-.7,max:.7},f={min:-.3,max:.3},p={neck:.3,head:.7},d={neck:.4,head:.6},y={neck:.2,head:.8};function w(e,t){return Math.max(t.min,Math.min(t.max,e))}function v(e,t,n){return e+(t-e)*n}const b=new a.Euler,L=(new a.Quaternion,new a.Matrix4,new a.Matrix4,new a.Matrix4,new a.Matrix4,new a.Matrix4,r.memo((e=>{let{avatarUrl:t,trackingData:n,position:L=[0,0,0],scale:R=1,participantId:k,animationName:T="idle",emotionalBlendshapes:S,audioData:_,gender:D}=e;const A=(0,r.useMemo)((()=>{if(D)return D;const e=(null===t||void 0===t?void 0:t.toLowerCase())||"";return e.includes("dougie")||e.includes("male")||e.includes("_m_")?"male":(e.includes("grace")||e.includes("female")||e.includes("_f_"),"female")}),[t,D]),I=void 0===n,O=I?"coach":"user",W=(0,r.useRef)(Math.random().toString(36).substr(2,9));(0,r.useEffect)((()=>(console.log("[PresenceAvatarWithGender-".concat(W.current,"] Mounted:"),{avatarType:O,participantId:k,hasTrackingData:!!n,avatarUrl:t,detectedGender:A,timestamp:Date.now()}),()=>{console.log("[PresenceAvatarWithGender-".concat(W.current,"] Unmounted"))})),[]);const{scene:q}=(0,i.p)(t||"/avatars/coach_grace.glb"),M=(0,r.useMemo)((()=>u.t.clone(q)),[q]),{nodes:P}=(0,o.G)(M),j="male"===A?"M":"F",x="/animations/".concat(j,"_Standing_Idle_001.glb"),{animations:G}=(0,i.p)(x),F=["/animations/".concat(j,"_Talking_Variations_001.glb"),"/animations/".concat(j,"_Talking_Variations_002.glb"),"/animations/".concat(j,"_Talking_Variations_003.glb"),"/animations/".concat(j,"_Talking_Variations_004.glb"),"/animations/".concat(j,"_Talking_Variations_005.glb"),"/animations/".concat(j,"_Talking_Variations_006.glb")],{animations:E}=(0,i.p)(F[0]),{animations:U}=(0,i.p)(F[1]),{animations:C}=(0,i.p)(F[2]),{animations:V}=(0,i.p)(F[3]),{animations:N}=(0,i.p)(F[4]),{animations:B}=(0,i.p)(F[5]),X=[...E,...U,...C,...V,...N,...B];F.forEach((e=>i.p.preload(e)));const Y=(0,r.useMemo)((()=>{const e=[...G,...X];return console.log("[PresenceAvatarWithGender] Loaded ".concat(e.length," animations for ").concat(A," avatar")),e}),[G,X,A]),{actions:Z,mixer:Q}=(0,c.f)(Y,M),z=(0,r.useRef)(null),H=(0,r.useRef)("idle"),J=(0,r.useRef)(null);(0,r.useEffect)((()=>{Z&&0!==Object.keys(Z).length&&(J.current&&clearTimeout(J.current),H.current!==T&&(J.current=setTimeout((()=>{if(H.current=T,Object.values(Z).forEach((e=>{e&&e.fadeOut(.3)})),"talking"===T){const e=Object.entries(Z).filter((e=>{let[t]=e;return t.toLowerCase().includes("talking")||t.toLowerCase().includes("talk")}));if(e.length>0){let t;if(console.log("[PresenceAvatarWithGender] Available talking animations:",e),e.length>1){let n=e.filter((e=>{let[t]=e;return t!==z.current}));0===n.length&&(n=e);t=n[Math.floor(Math.random()*n.length)]}else t=e[0];const[n,r]=t;console.log("[PresenceAvatarWithGender] Playing talking animation:",n),z.current=n,r&&(r.reset(),r.setLoop(a.LoopRepeat,1/0),r.fadeIn(.3),r.timeScale=.7,r.play())}}else{const e=Object.entries(Z).find((e=>{let[t]=e;return t.toLowerCase().includes("idle")}));if(e){const[t,n]=e;console.log("[PresenceAvatarWithGender] Playing idle animation:",t),n&&(n.reset(),n.setLoop(a.LoopRepeat,1/0),n.fadeIn(.3),n.timeScale=.8,n.play())}}}),100)))}),[T,Z]);const K=(0,r.useRef)([]),$=(0,r.useRef)(null),ee=(0,r.useRef)(null);(0,r.useEffect)((()=>{K.current=[],M.traverse((e=>{e instanceof a.SkinnedMesh&&e.morphTargetDictionary&&(K.current.push(e),console.log("[PresenceAvatarWithGender] Found mesh with morph targets:",e.name,Object.keys(e.morphTargetDictionary))),e instanceof a.Bone&&(e.name.toLowerCase().includes("head")?($.current=e,console.log("[PresenceAvatarWithGender] Found head bone:",e.name)):e.name.toLowerCase().includes("neck")&&(ee.current=e,console.log("[PresenceAvatarWithGender] Found neck bone:",e.name)))}))}),[M]);const te=(0,r.useRef)({pitch:0,yaw:0,roll:0}),ne=(0,r.useRef)({volume:0,frequency:0}),re=(0,r.useRef)(!1),ae=(0,r.useRef)(0);(0,o.F)((()=>{if(0!==K.current.length){if(_&&_.length>0){let e=0,t=0;for(let n=0;n<_.length;n++)e+=_[n],t=Math.max(t,_[n]);ne.current.volume=e/_.length/255,ne.current.frequency=t/255,ae.current%60===0&&console.log("[PresenceAvatarWithGender] Audio data:",{hasAudioData:!0,dataLength:_.length,volume:ne.current.volume,frequency:ne.current.frequency,max:t,sum:e,participantId:k,isCoachAvatar:I})}else ne.current.volume=0,ne.current.frequency=0;if(ae.current++,re.current||(console.log("[PresenceAvatarWithGender] Morph targets found:",K.current.map((e=>({name:e.name,morphTargets:Object.keys(e.morphTargetDictionary||{})})))),re.current=!0),S&&K.current.forEach((e=>{e.morphTargetDictionary&&e.morphTargetInfluences&&Object.entries(S).forEach((t=>{let[n,r]=t;const o=h[n];o&&o.forEach((t=>{const n=s[t];if(n&&e.morphTargetDictionary){const t=e.morphTargetDictionary[n.target];if(void 0!==t&&e.morphTargetInfluences){const o=r*(n.amplify||1);e.morphTargetInfluences[t]=a.MathUtils.clamp(o,0,1)}}}))}))})),_&&_.length>0&&(Math.random()<.01&&console.log("[PresenceAvatarWithGender] Audio analysis:",{volume:ne.current.volume,frequency:ne.current.frequency,audioDataLength:_.length,isCoachAvatar:I,gender:A}),K.current.forEach((e=>{if(!e.morphTargetDictionary||!e.morphTargetInfluences)return;const t=["mouthOpen","jawOpen","viseme_aa","viseme_O","0","1"];let n=!1;for(const o of t)if(void 0!==e.morphTargetDictionary[o]){const t=.8*ne.current.volume,r=e.morphTargetDictionary[o],a=e.morphTargetInfluences[r];if(e.morphTargetInfluences[r]=v(a,t,.3),Math.random()<.01&&t>.01&&console.log("[PresenceAvatarWithGender] Applied lip sync to ".concat(o,":"),{targetValue:t,currentValue:a,morphIndex:r,meshName:e.name}),"0"===o&&void 0!==e.morphTargetDictionary[1]){const t=e.morphTargetDictionary[1],n=.4*ne.current.volume;e.morphTargetInfluences[t]=v(e.morphTargetInfluences[t],n,.3)}n=!0;break}n||re.current||(console.warn("[PresenceAvatarWithGender] No jaw/mouth morph target found! Available targets:",Object.keys(e.morphTargetDictionary)),re.current=!0);const r=e.morphTargetDictionary.mouthSmileLeft,a=e.morphTargetDictionary.mouthSmileRight;if(void 0!==r&&void 0!==a){const t=.3*ne.current.frequency;e.morphTargetInfluences[r]=v(e.morphTargetInfluences[r],t,.2),e.morphTargetInfluences[a]=v(e.morphTargetInfluences[a],t,.2)}}))),n&&n.rotation){const{pitch:e,yaw:t,roll:r}=n.rotation;te.current.pitch=v(te.current.pitch,w(e,m),.1),te.current.yaw=v(te.current.yaw,w(t,g),.1),te.current.roll=v(te.current.roll,w(r,f),.1),ee.current&&(b.set(te.current.pitch*p.neck,te.current.yaw*d.neck,te.current.roll*y.neck,"XYZ"),ee.current.quaternion.setFromEuler(b)),$.current&&(b.set(te.current.pitch*p.head,te.current.yaw*d.head,te.current.roll*y.head,"XYZ"),$.current.quaternion.setFromEuler(b)),n.expressions&&K.current.forEach((e=>{e.morphTargetDictionary&&e.morphTargetInfluences&&Object.entries(n.expressions).forEach((t=>{let[n,r]=t;const a=e.morphTargetDictionary[n];void 0!==a&&(e.morphTargetInfluences[a]=r)}))}))}}}));const oe=Array.isArray(L)&&3===L.length?L:[0,0,0];return(0,l.jsx)("group",{position:oe,scale:R,children:(0,l.jsx)("primitive",{object:M})})})));L.displayName="PresenceAvatarWithGender",["/avatars/coach_grace.glb","/avatars/Dougie.glb","/animations/M_Standing_Idle_001.glb","/animations/F_Standing_Idle_001.glb"].forEach((e=>{i.p.preload(e)}))}}]);
//# sourceMappingURL=7990.52657230.chunk.js.map