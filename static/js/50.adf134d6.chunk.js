"use strict";(self.webpackChunkhub=self.webpackChunkhub||[]).push([[50],{10050:(e,t,n)=>{n.r(t),n.d(t,{MasculinePresenceAvatar:()=>f,default:()=>d});var a=n(65043),i=n(29408),r=n(79183),o=n(81597),l=n(5355),s=n(52652),c=n(70579);const g={browInnerUp:{target:"browInnerUp",amplify:1.5},browDownLeft:{target:"browDownLeft",amplify:1.8},browDownRight:{target:"browDownRight",amplify:1.8},browOuterUpLeft:{target:"browOuterUpLeft",amplify:1.5},browOuterUpRight:{target:"browOuterUpRight",amplify:1.5},mouthSmileLeft:{target:"mouthSmileLeft",amplify:2.5},mouthSmileRight:{target:"mouthSmileRight",amplify:2.5},mouthFrownLeft:{target:"mouthFrownLeft",amplify:2.2},mouthFrownRight:{target:"mouthFrownRight",amplify:2.2},mouthOpen:{target:"mouthOpen",amplify:1},mouthPucker:{target:"mouthPucker",amplify:1.8},mouthLeft:{target:"mouthLeft",amplify:1.5},mouthRight:{target:"mouthRight",amplify:1.5},eyeSquintLeft:{target:"eyeSquintLeft",amplify:1.4},eyeSquintRight:{target:"eyeSquintRight",amplify:1.4},eyeWideLeft:{target:"eyeWideLeft",amplify:1.2},eyeWideRight:{target:"eyeWideRight",amplify:1.2},cheekPuff:{target:"cheekPuff",amplify:1.5},cheekSquintLeft:{target:"cheekSquintLeft",amplify:1.3},cheekSquintRight:{target:"cheekSquintRight",amplify:1.3},noseSneerLeft:{target:"noseSneerLeft",amplify:1.5},noseSneerRight:{target:"noseSneerRight",amplify:1.5},jawOpen:{target:"jawOpen",amplify:1},jawLeft:{target:"jawLeft",amplify:1.2},jawRight:{target:"jawRight",amplify:1.2}},u={joy:["mouthSmileLeft","mouthSmileRight","cheekSquintLeft","cheekSquintRight"],sadness:["mouthFrownLeft","mouthFrownRight","browDownLeft","browDownRight"],anger:["browDownLeft","browDownRight","noseSneerLeft","noseSneerRight"],fear:["eyeWideLeft","eyeWideRight","browInnerUp","mouthOpen"],surprise:["eyeWideLeft","eyeWideRight","browOuterUpLeft","browOuterUpRight","mouthOpen"],disgust:["noseSneerLeft","noseSneerRight","mouthFrownLeft","mouthFrownRight"],contempt:["mouthLeft","mouthRight","eyeSquintLeft","eyeSquintRight"]};function m(e,t){return Math.max(t.min,Math.min(t.max,e))}function h(e,t,n){return e+(t-e)*n}new i.Euler,new i.Quaternion,new i.Matrix4,new i.Matrix4;const p={idle:["/animations/M_Standing_Idle_001.glb","/animations/M_Standing_Idle_002.glb","/animations/M_Standing_Idle_Variations_001.glb","/animations/M_Standing_Idle_Variations_002.glb","/animations/M_Standing_Idle_Variations_003.glb","/animations/M_Standing_Idle_Variations_004.glb","/animations/M_Standing_Idle_Variations_005.glb","/animations/M_Standing_Idle_Variations_006.glb","/animations/M_Standing_Idle_Variations_007.glb","/animations/M_Standing_Idle_Variations_008.glb","/animations/M_Standing_Idle_Variations_009.glb","/animations/M_Standing_Idle_Variations_010.glb"],talking:["/animations/M_Talking_Variations_001.glb","/animations/M_Talking_Variations_002.glb","/animations/M_Talking_Variations_003.glb","/animations/M_Talking_Variations_004.glb","/animations/M_Talking_Variations_005.glb","/animations/M_Talking_Variations_006.glb","/animations/M_Talking_Variations_007.glb","/animations/M_Talking_Variations_008.glb","/animations/M_Talking_Variations_009.glb","/animations/M_Talking_Variations_010.glb"]},f=e=>{let{avatarUrl:t,position:n=[0,0,0],scale:f=1,trackingData:d,animationName:y="idle",emotionalBlendshapes:_,audioData:b,participantId:T="unnamed"}=e;const M=void 0===d,k=_&&Object.keys(_).length>0,v=(0,a.useRef)(null),w=(0,a.useRef)(null),R=(0,a.useRef)(null),S=(0,a.useRef)(null),D=(0,a.useRef)(null),L=(0,a.useRef)(null),I=(0,a.useRef)(null),O=(0,a.useRef)(null),j=((0,a.useRef)(null),(0,a.useRef)(0)),x=((0,a.useRef)(0),(0,a.useRef)({}),(0,a.useRef)({}),(0,a.useRef)(!1)),{scene:A}=(0,o.p)(t||"/avatars/dougie.glb"),P=(0,a.useMemo)((()=>{if(!A)return null;return s.t.clone(A)}),[A]),{animations:V=[]}=(0,o.p)(p.idle[0]),{animations:E=[]}=(0,o.p)(p.talking[0]),{animations:q=[]}=(0,o.p)(p.talking[1]),{animations:U=[]}=(0,o.p)(p.talking[2]),{animations:F=[]}=(0,o.p)(p.talking[3]),{animations:C=[]}=(0,o.p)(p.talking[4]),{animations:W=[]}=(0,o.p)(p.talking[5]),{animations:N=[]}=(0,o.p)(p.talking[6]),{animations:B=[]}=(0,o.p)(p.talking[7]),{animations:z=[]}=(0,o.p)(p.talking[8]),{animations:H=[]}=(0,o.p)(p.talking[9]),Q=(0,a.useMemo)((()=>[...E,...q,...U,...F,...C,...W,...N,...B,...z,...H]),[E,q,U,F,C,W,N,B,z,H]),G=(0,a.useMemo)((()=>[...V,...Q]),[V,Q]);(0,a.useEffect)((()=>{p.idle.forEach((e=>o.p.preload(e))),p.talking.forEach((e=>o.p.preload(e)))}),[]);const{actions:J,mixer:K}=(0,l.f)(G,P||v),X=(0,a.useRef)(null),Y=(0,a.useRef)(null);(0,a.useEffect)((()=>{if(!J||0===Object.keys(J).length)return void console.log("[MasculinePresenceAvatar] No animation actions available to play.");(e=>{var t;const n=X.current;if(n===e&&null!==(t=J[e])&&void 0!==t&&t.isRunning())return;let a=e;if("talking"===e){const e=Object.keys(J).filter((e=>e.toLowerCase().includes("talk")||e.toLowerCase().includes("talking")));e.length>0?(a=e[Math.floor(Math.random()*e.length)],Y.current=a):Y.current&&J[Y.current]&&(a=Y.current)}else if("idle"===e){const e=Object.keys(J).filter((e=>e.toLowerCase().includes("idle")));e.length>0&&(a=e[0])}const i=J[a];i?(n&&J[n]&&(J[n].fadeOut(.3),setTimeout((()=>{var e;null===(e=J[n])||void 0===e||e.stop()}),300)),i.reset(),i.fadeIn(.5),i.timeScale=.5,i.play(),console.log("[MasculinePresenceAvatar] Playing animation:",a,"timeScale:",i.timeScale),X.current=a):console.warn('[MasculinePresenceAvatar] Animation "'.concat(a,'" not found'))})(y)}),[y,J]),(0,a.useEffect)((()=>{if(!P)return;console.log("[MasculinePresenceAvatar] Setting up model...");let e=null,t=0;null===P||void 0===P||P.traverse((n=>{if(n instanceof i.SkinnedMesh)t++,console.log("[MasculinePresenceAvatar] Found SkinnedMesh:",{name:n.name,hasMorphTargetDictionary:!!n.morphTargetDictionary,morphTargetCount:n.morphTargetDictionary?Object.keys(n.morphTargetDictionary).length:0,morphTargets:n.morphTargetDictionary?Object.keys(n.morphTargetDictionary).slice(0,5):[]}),n.morphTargetDictionary&&(e=n,R.current=n,e.morphTargetInfluences&&(e.morphTargetInfluences=e.morphTargetInfluences.map((()=>0))),x.current||(console.log("[MasculinePresenceAvatar] Available morph targets:",Object.keys(n.morphTargetDictionary)),x.current=!0));else if(n instanceof i.Bone){const e=n.name.toLowerCase();e.includes("head")&&!e.includes("headtop")?(S.current=n,I.current=n.quaternion.clone()):e.includes("neck")?(D.current=n,O.current=n.quaternion.clone()):e.includes("jaw")&&(L.current=n)}})),w.current=P,console.log("[MasculinePresenceAvatar] Model setup complete",{hasMorphTargets:!!e,hasHeadBone:!!S.current,hasNeckBone:!!D.current,meshCount:t})}),[P]);const Z=(0,a.useMemo)((()=>{if(!d||void 0===d)return null;let e={},t=null;return d.facialExpressions&&(e=d.facialExpressions),d.headRotation&&"object"===typeof d.headRotation&&"pitch"in d.headRotation&&(t=d.headRotation),{facialExpressions:e,headRotation:t}}),[d]);return(0,r.F)(((e,t)=>{if(!w.current)return;const n=60*e.clock.elapsedTime;j.current=Math.floor(n);const a=Z,r=R.current;if("talking"===y&&b&&b.length>0){if(j.current%30===0&&console.log("[MasculinePresenceAvatar] Lip sync check:",{hasMesh:!!r,hasMorphTargetDictionary:!(null===r||void 0===r||!r.morphTargetDictionary),morphTargetCount:null!==r&&void 0!==r&&r.morphTargetDictionary?Object.keys(r.morphTargetDictionary).length:0,morphTargets:null!==r&&void 0!==r&&r.morphTargetDictionary?Object.keys(r.morphTargetDictionary).slice(0,10):[],audioDataLength:b.length,animationName:y}),null!==r&&void 0!==r&&r.morphTargetDictionary){let e=0;const t=Math.min(64,b.length);let n=0;for(let i=0;i<t;i++){let t=1;i>=2&&i<=20&&(t=2);e+=b[i]*t,n=Math.max(n,b[i])}const a=t>0?e/t/255:0,o=n/255,l=Math.max(a,.7*o);0===j.current&&console.log("[MasculinePresenceAvatar] Available morph targets:",Object.keys(r.morphTargetDictionary));const s=["jawOpen","mouthOpen","viseme_aa","viseme_O","0","1"];let c=!1;for(const g of s)if(void 0!==r.morphTargetDictionary[g]){const t=i.MathUtils.clamp(2*l,0,.4),s=r.morphTargetDictionary[g];if(r.morphTargetInfluences&&void 0!==s&&(r.morphTargetInfluences[s]=t),"0"===g&&void 0!==r.morphTargetDictionary[1]){const e=r.morphTargetDictionary[1];r.morphTargetInfluences&&void 0!==e&&(r.morphTargetInfluences[e]=.5*t)}j.current%30===0&&l>0&&console.log("[MasculinePresenceAvatar] Lip sync applied:",{target:g,averageEnergy:a,peakEnergy:o,combinedEnergy:l,lipSyncValue:t,morphIndex:s,totalEnergy:e,maxEnergy:n,audioDataLength:b.length,audioDataSample:Array.from(b.slice(0,10))}),c=!0;break}c||j.current%300!==0||console.warn("[MasculinePresenceAvatar] No jaw/mouth morph target found! Available targets:",Object.keys(r.morphTargetDictionary))}}else"idle"===y&&null!==r&&void 0!==r&&r.morphTargetInfluences&&null!==r&&void 0!==r&&r.morphTargetDictionary&&Object.keys(r.morphTargetDictionary).forEach((e=>{const t=r.morphTargetDictionary[e];void 0!==t&&r.morphTargetInfluences&&(r.morphTargetInfluences[t]=0)}));if(k&&null!==r&&void 0!==r&&r.morphTargetDictionary){var o;if(j.current%60===0)console.log("[MasculinePresenceAvatar] Mesh info:",{hasMesh:!!r,morphTargetDictionary:Object.keys(r.morphTargetDictionary||{}),morphTargetInfluences:(null===(o=r.morphTargetInfluences)||void 0===o?void 0:o.length)||0});Object.entries(_).forEach((e=>{let[t,n]=e;const a=u[t];a&&a.forEach((e=>{const a=g[e];if(a&&void 0!==r.morphTargetDictionary[a.target]){const o=r.morphTargetDictionary[a.target],l=n*(a.amplify||1);r.morphTargetInfluences&&(r.morphTargetInfluences[o]=i.MathUtils.clamp(l,0,1),l>.1&&j.current%60===0&&console.log("[MasculinePresenceAvatar] Setting morph:",{emotion:t,blendshape:e,targetName:a.target,targetIndex:o,value:l}))}else n>.1&&j.current%60===0&&console.warn("[MasculinePresenceAvatar] Missing morph target:",{emotion:t,blendshape:e,attemptedTarget:null===a||void 0===a?void 0:a.target,available:Object.keys(r.morphTargetDictionary||{}).slice(0,10)})}))}))}else null!==a&&void 0!==a&&a.facialExpressions&&null!==r&&void 0!==r&&r.morphTargetDictionary&&Object.entries(a.facialExpressions).forEach((e=>{let[t,n]=e;if(void 0!==r.morphTargetDictionary[t]){const e=r.morphTargetDictionary[t];r.morphTargetInfluences&&(r.morphTargetInfluences[e]=i.MathUtils.clamp(n,0,1))}}));if(null!==a&&void 0!==a&&a.headRotation&&S.current&&!M){const e=a.headRotation;if(e&&"object"===typeof e){const t=.8;S.current.rotation.x=h(S.current.rotation.x,m(.5*-e.pitch,{min:-.5,max:.5}),t),S.current.rotation.y=h(S.current.rotation.y,m(.5*e.yaw,{min:-.7,max:.7}),t),S.current.rotation.z=h(S.current.rotation.z,m(.3*-e.roll,{min:-.3,max:.3}),t)}}K&&K.update(t),!R.current&&P&&P.traverse((e=>{e instanceof i.SkinnedMesh&&e.morphTargetDictionary&&(R.current=e,console.log("[MasculinePresenceAvatar] Found mesh with morph targets in frame"))}))})),P&&w.current?(0,c.jsx)("group",{ref:v,position:n,scale:f,children:(0,c.jsx)("primitive",{object:w.current})}):null},d=f}}]);
//# sourceMappingURL=50.adf134d6.chunk.js.map