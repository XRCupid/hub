"use strict";(self.webpackChunkhub=self.webpackChunkhub||[]).push([[2578],{92578:(e,r,t)=>{t.r(r),t.d(r,{UserAvatarPiP:()=>v});var a=t(9950),n=t(52111),s=t(68057),i=t(32094),o=t(41418),l=(t(63828),t(44414));class c extends a.Component{constructor(e){super(e),this.state={hasError:!1,error:null}}static getDerivedStateFromError(e){return console.error("[CanvasErrorBoundary] Caught error:",e),{hasError:!0,error:e}}componentDidCatch(e,r){console.error("[CanvasErrorBoundary] Error details:",e,r)}render(){var e;return this.state.hasError?(0,l.jsxs)("div",{style:{padding:"20px",color:"red"},children:[(0,l.jsx)("h3",{children:"Canvas Error"}),(0,l.jsx)("p",{children:null===(e=this.state.error)||void 0===e?void 0:e.message})]}):this.props.children}}const d=e=>{let{avatarUrl:r,trackingData:t,idleAnimationUrl:i="/animations/M_Standing_Idle_001.glb",onContextLost:d}=e;return console.log("[AvatarCanvas] Rendering with:",{avatarUrl:r,hasTrackingData:!!t}),a.useEffect((()=>(console.log("[AvatarCanvas] Mounted"),()=>{console.log("[AvatarCanvas] Unmounting!")})),[]),(0,l.jsx)(c,{children:(0,l.jsxs)(n.Hl,{camera:{position:[0,1.5,2],fov:28,near:.1,far:100},style:{width:"100%",height:"100%"},gl:{preserveDrawingBuffer:!0},onCreated:e=>{let{gl:r}=e;console.log("[AvatarCanvas] WebGL context created");const t=r.domElement;t.addEventListener("webglcontextlost",(e=>{console.error("[AvatarCanvas] WebGL context lost!",e),e.preventDefault(),d&&d()})),t.addEventListener("webglcontextrestored",(e=>{console.log("[AvatarCanvas] WebGL context restored",e)}))},children:[(0,l.jsx)("ambientLight",{intensity:.6}),(0,l.jsx)("directionalLight",{position:[0,10,5],intensity:.8,castShadow:!0,"shadow-mapSize":[1024,1024]}),(0,l.jsx)("directionalLight",{position:[0,5,10],intensity:.5}),(0,l.jsx)(a.Suspense,{fallback:null,children:(0,l.jsx)(o.PresenceAvatar,{avatarUrl:r,trackingData:t,position:[0,0,0],scale:1})}),(0,l.jsx)(s.N,{enablePan:!1,enableZoom:!1,enableRotate:!1,target:[0,1.5,0]})]})})};d.displayName="AvatarCanvas";const u=(e,r)=>e.avatarUrl===r.avatarUrl&&e.idleAnimationUrl===r.idleAnimationUrl,g=a.memo(d,u),v=e=>{var r;let{avatarUrl:t="/avatars/default_avatar.glb",onClose:n,position:s="bottom-right",size:o="medium",trackingData:c}=e;console.log("[UserAvatarPiP] Component rendering with props:",{avatarUrl:t,position:s,size:o,hasTrackingData:!!c});const[d,u]=(0,a.useState)(!1),[v,p]=(0,a.useState)({facialExpressions:null,posture:null,hands:null}),h=(0,a.useRef)(v),[m,x]=(0,a.useState)(null),[f,k]=(0,a.useState)(!1),[b,j]=(0,a.useState)(0),[C,y]=(0,a.useState)("ML5"),E=(0,a.useRef)(null),U=(0,a.useRef)(null),A=(0,a.useRef)(null),w=(0,a.useRef)(null),P=(0,a.useCallback)((()=>{console.error("[UserAvatarPiP] WebGL context lost, attempting recovery..."),x("WebGL context lost"),setTimeout((()=>{x(null),j((e=>e+1))}),1e3)}),[]);(0,a.useEffect)((()=>{c&&(h.current=c)}),[c]);a.useEffect((()=>{console.log("[UserAvatarPiP] State updated:",{isTracking:d,hasError:!!m,isMinimized:f,hasTrackingData:!!v})}),[d,m,f,v]),(0,a.useEffect)((()=>{if(c)return console.log("[UserAvatarPiP] Using trackingData from parent"),p(c),u(!0),void y("Parent");console.log("[UserAvatarPiP] No trackingData provided, initializing camera tracking");return(async()=>{try{if(!U.current){U.current=new i.L;y(!1?"ML5 + Hume":"ML5")}await U.current.initialize();const e=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:640},height:{ideal:480},facingMode:"user"}});A.current=e,E.current&&(E.current.srcObject=e,await new Promise((e=>{E.current&&(E.current.onloadedmetadata=()=>{E.current.play(),e()})})),L())}catch(e){console.error("Failed to initialize tracking:",e),x("Failed to access camera or initialize tracking")}})(),()=>{D(),A.current&&A.current.getTracks().forEach((e=>e.stop()))}}),[]);const L=async()=>{if(c)console.log("[UserAvatarPiP] Using parent trackingData, skipping camera tracking");else try{if(!U.current||!E.current)throw new Error("Tracking service or video not initialized");u(!0),x(""),await U.current.startTracking(E.current),w.current=setInterval((async()=>{if(U.current){const e=U.current.getExpressions(),r=U.current.getHeadRotation(),t=U.current.getPostureData(),a=U.current.getLandmarks();Math.random()<.05&&console.log("[UserAvatarPiP] Raw tracking data:",{expressions:e,headRotation:r,expressionKeys:e?Object.keys(e):null,hasAnyExpression:!!e&&Object.values(e).some((e=>e>0))}),h.current={facialExpressions:e,headRotation:r,posture:t,hands:null,landmarks:a||[]},p(h.current)}}),50)}catch(e){console.error("Tracking error:",e),x(e.message||"Failed to start tracking"),u(!1)}},D=()=>{w.current&&(clearInterval(w.current),w.current=null),U.current&&U.current.stopTracking(),u(!1)};return(0,l.jsxs)("div",{className:"user-avatar-pip ".concat(s," ").concat((()=>{switch(o){case"small":return"pip-small";case"large":return"pip-large";default:return"pip-medium"}})()," ").concat(f?"minimized":""),children:[(0,l.jsx)("video",{ref:E,style:{display:"none"},playsInline:!0,muted:!0}),n&&(0,l.jsx)("button",{className:"pip-close-button",onClick:n,title:"Close",children:"\u2715"}),(0,l.jsxs)("div",{className:"pip-content",children:[m?(0,l.jsxs)("div",{className:"pip-error",children:[(0,l.jsx)("p",{children:m}),(0,l.jsx)("button",{onClick:()=>{x(null),j((e=>e+1))},children:"Retry"})]}):(0,l.jsx)("div",{style:{width:"100%",height:"100%"},children:(0,l.jsx)(g,{avatarUrl:t,trackingData:c||v,idleAnimationUrl:"/animations/M_Standing_Idle_001.glb",onContextLost:P})},"avatar-canvas-container-".concat(b)),(null===(r=c||v)||void 0===r?void 0:r.facialExpressions)&&!m&&(0,l.jsx)("div",{className:"expression-debug",children:(0,l.jsxs)("div",{className:"expression-mini",children:[d&&(0,l.jsx)("div",{style:{color:"lime",fontSize:"10px"},children:"\u25cf TRACKING ACTIVE"}),Object.entries((c||v).facialExpressions).filter((e=>{let[r,t]=e;return t>.2})).slice(0,3).map((e=>{let[r,t]=e;return(0,l.jsxs)("div",{style:{fontSize:"10px",marginBottom:"2px"},children:[r,": ",(100*t).toFixed(0),"%"]},r)}))]})})]})]})}}}]);