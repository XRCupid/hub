"use strict";(self.webpackChunkhub=self.webpackChunkhub||[]).push([[9203],{79203:(e,n,s)=>{s.r(n),s.d(n,{default:()=>u});var a=s(9950),t=s(93498),c=s(52111),o=s(41418),r=s(42549),i=s(68122),l=s(82570),d=(s(4371),s(44414));const u=()=>{const{coachId:e}=(0,t.g)(),n=(0,t.Zp)(),[s,u]=(0,a.useState)(!1),[h,m]=(0,a.useState)(!1),[g,p]=(0,a.useState)(!1),[b,x]=(0,a.useState)({}),[v,j]=(0,a.useState)(new Uint8Array),[C,y]=(0,a.useState)(""),[f,S]=(0,a.useState)(""),[k,A]=(0,a.useState)(!1),[w,N]=(0,a.useState)(null),[E,R]=(0,a.useState)({facialExpressions:{jawOpen:0}}),[O,U]=(0,a.useState)(""),L=(0,a.useRef)(null),z=(0,a.useRef)(null),I=(0,a.useRef)(null),P=(0,a.useRef)(null),F=l.r5[e];(0,a.useEffect)((()=>{if(!F)return void n("/training-hub");const e=window.AudioContext||window.webkitAudioContext;return e&&(L.current=new e,z.current=L.current.createAnalyser(),z.current.fftSize=256,z.current.smoothingTimeConstant=.8),i.A.setOnAudioCallback((e=>{M(e)})),i.A.setOnEmotionCallback((e=>{x(e)})),i.A.setOnMessageCallback((e=>{var n;"assistant_message"===e.type&&null!==(n=e.message)&&void 0!==n&&n.content&&y(e.message.content)})),i.A.setOnUserMessageCallback((e=>{S(e)})),i.A.setOnUserInterruptionCallback((()=>{m(!1),p(!0)})),i.A.setOnErrorCallback((e=>{console.error("[CoachSession] Hume error:",e),N(e.message),u(!1)})),()=>{var e,n;(I.current&&cancelAnimationFrame(I.current),P.current&&(P.current.pause(),P.current=null),"closed"!==(null===(e=L.current)||void 0===e?void 0:e.state))&&(null===(n=L.current)||void 0===n||n.close())}}),[F,n]),(0,a.useEffect)((()=>()=>{console.log("[CoachSession] Cleaning up on unmount"),s&&i.A.disconnect(),I.current&&cancelAnimationFrame(I.current),L.current&&L.current.close()}),[]);const M=async e=>{try{P.current&&(console.log("[CoachSession] Stopping previous audio"),P.current.pause(),P.current=null);const n=URL.createObjectURL(e),s=new Audio(n);P.current=s,console.log("[CoachSession] Playing new audio blob, size:",e.size),s.addEventListener("canplay",(async()=>{m(!0),await B(s)})),s.addEventListener("ended",(()=>{console.log("[CoachSession] Audio ended"),m(!1),p(!0),URL.revokeObjectURL(n),P.current===s&&(P.current=null)})),await s.play()}catch(w){console.error("[CoachSession] Error playing audio:",w),m(!1)}},B=async e=>{if(!L.current||!z.current)return;"suspended"===L.current.state&&(console.log("[CoachSession] Resuming audio context..."),await L.current.resume());const n=L.current.createMediaElementSource(e);n.connect(z.current),z.current.connect(L.current.destination),console.log("[CoachSession] Audio connected:",{contextState:L.current.state,analyserConnected:!!z.current,sourceConnected:!!n});const s=()=>{if(!z.current)return;const e=new Uint8Array(z.current.frequencyBinCount);z.current.getByteFrequencyData(e);const n=e.reduce(((e,n)=>e+n),0)/e.length;n>0&&console.log("[CoachSession] Audio data:",{avgVolume:n,isSpeaking:h,dataLength:e.length}),j(e);const a=.3*Math.min(n/128,1);R({facialExpressions:{jawOpen:a,mouthOpen:.8*a}}),h&&(I.current=requestAnimationFrame(s))};s()},D=async e=>{if(e.trim()&&s)try{S(e),i.A.sendMessage(e)}catch(w){console.error("[CoachSession] Error sending message:",w)}};return F?(0,d.jsxs)("div",{className:"coach-session",children:[(0,d.jsxs)("div",{className:"coach-header",children:[(0,d.jsx)("button",{className:"back-button",onClick:()=>n("/training-hub"),children:"\u2190 Back to Training Hub"}),(0,d.jsxs)("h1",{children:["Session with ",F.name]}),(0,d.jsx)("div",{className:"connection-status",children:s?(0,d.jsx)("span",{className:"status-connected",children:"\u25cf Connected"}):(0,d.jsx)("span",{className:"status-disconnected",children:"\u25cf Disconnected"})})]}),(0,d.jsxs)("div",{className:"coach-content",children:[(0,d.jsx)("div",{className:"coach-avatar-scene",style:{backgroundImage:F.venue?"url(/venues/".concat(F.venue,")"):void 0,backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat",position:"relative",zIndex:1},children:(0,d.jsxs)(c.Hl,{shadows:!0,camera:{position:[0,0,2.5],fov:35},children:[(0,d.jsx)("ambientLight",{intensity:.8}),(0,d.jsx)("directionalLight",{position:[0,1,2],intensity:1.2}),(0,d.jsx)(a.Suspense,{fallback:null,children:(0,d.jsx)(o.PresenceAvatar,{avatarUrl:F.avatar,animationName:h?"talking":"idle",position:[0,-1.4,0],scale:1,audioData:h?v:void 0})})]})}),(0,d.jsx)("div",{className:"coach-interaction",children:s?(0,d.jsxs)("div",{className:"conversation-panel",children:[(0,d.jsxs)("div",{className:"coach-message",children:[(0,d.jsxs)("h3",{children:[F.name," says:"]}),(0,d.jsx)("p",{children:C||"..."})]}),(0,d.jsxs)("div",{className:"emotion-display",children:[(0,d.jsx)("h4",{children:"Emotional Analysis"}),(0,d.jsx)("div",{className:"emotion-bars",children:Object.entries(b).map((e=>{let[n,s]=e;return(0,d.jsxs)("div",{className:"emotion-bar",children:[(0,d.jsx)("span",{className:"emotion-label",children:n}),(0,d.jsx)("div",{className:"emotion-progress",children:(0,d.jsx)("div",{className:"emotion-fill",style:{width:"".concat(100*(s||0),"%")}})})]},n)}))})]}),(0,d.jsxs)("div",{className:"user-input",children:[(0,d.jsx)("h4",{children:"Your response:"}),(0,d.jsx)("p",{children:f||(g?"Listening...":"...")})]}),(0,d.jsxs)("div",{className:"manual-input",style:{marginTop:"20px"},children:[(0,d.jsx)("input",{type:"text",value:O,onChange:e=>U(e.target.value),onKeyPress:e=>{"Enter"===e.key&&(D(O),U(""))},placeholder:"Type a message and press Enter",style:{width:"100%",padding:"10px",borderRadius:"5px",border:"1px solid #ccc",marginBottom:"10px"}}),(0,d.jsx)("button",{onClick:()=>{D(O),U("")},style:{padding:"10px 20px",backgroundColor:"#4CAF50",color:"white",border:"none",borderRadius:"5px",cursor:"pointer"},children:"Send Message"})]}),(0,d.jsx)("div",{className:"session-controls",children:(0,d.jsx)("button",{className:"end-session-button",onClick:async()=>{try{await i.A.disconnect(),u(!1),m(!1),p(!1)}catch(w){console.error("[CoachSession] Disconnect error:",w)}},children:"End Session"})})]}):(0,d.jsxs)("div",{className:"connection-panel",children:[(0,d.jsx)("h2",{children:"Ready to start your session?"}),(0,d.jsx)("p",{children:F.description}),(0,d.jsx)("button",{className:"connect-button",onClick:async()=>{try{A(!0),N(null);const e=F.humeConfigId||"bfd6db39-f0ea-46c3-a64b-e902d8cec212";console.log("[CoachSession] Connecting with:",{coachName:F.name,configId:e,humeConfigIdFromCoach:F.humeConfigId,envGrace:"bfd6db39-f0ea-46c3-a64b-e902d8cec212",envPosie:"dbf8debd-6835-489f-a7c3-a38fde6bb859",envRizzo:"0643bb10-61b5-43a8-ae1d-eb0051afc0a8"}),await i.A.connect(e),u(!0),console.log("[CoachSession] Connected to Hume voice service with config:",e)}catch(w){console.error("[CoachSession] Connection error:",w),N("Failed to connect to coach. Please try again.")}finally{A(!1)}},disabled:k,children:k?"Connecting...":"Start Session"}),w&&(0,d.jsx)("div",{className:"error-message",children:w})]})})]}),s&&(0,d.jsx)(r.UserAvatarPiP,{avatarUrl:"/avatars/user_avatar.glb",position:"top-right",size:"medium"})]}):null}}}]);