(self.webpackChunkhub=self.webpackChunkhub||[]).push([[6443,9605],{10952:()=>{},13678:()=>{},26308:()=>{},29645:()=>{},33166:(e,o,t)=>{"use strict";t.r(o),t.d(o,{SimulationView:()=>U});var s=t(89379),n=t(85224),i=t.n(n),a=t(9950),r=t(93498),l=t(67409),c=t(15255),u=t(41188),m=t(64189),d=t(56443),g=t(91367),p=t(63670),h=(t(23849),t(47450)),S=t(212),f=t(98905),y=t(20868);const A={AA:"\u0251",AE:"\xe6",AH:"\u028c",AO:"\u0254",AW:"a\u028a",AY:"a\u026a",B:"b",CH:"t\u0283",D:"d",DH:"\xf0",EH:"\u025b",ER:"\u025d",EY:"e\u026a",F:"f",G:"g",HH:"h",IH:"\u026a",IY:"i",JH:"d\u0292",K:"k",L:"l",M:"m",N:"n",NG:"\u014b",OW:"o\u028a",OY:"\u0254\u026a",P:"p",R:"\u0279",S:"s",SH:"\u0283",T:"t",TH:"\u03b8",UH:"\u028a",UW:"u",V:"v",W:"w",Y:"j",Z:"z",ZH:"\u0292",SIL:"silence",PAU:"silence",AX:"\u0259"},v=[{ipaSymbols:["silence"],id:0},{ipaSymbols:["\xe6","\u0259","\u028c"],id:1},{ipaSymbols:["\u0251"],id:2},{ipaSymbols:["\u0254"],id:3},{ipaSymbols:["\u025b","\u028a"],id:4},{ipaSymbols:["\u025d"],id:5},{ipaSymbols:["j","i","\u026a"],id:6},{ipaSymbols:["w","u"],id:7},{ipaSymbols:["o"],id:8},{ipaSymbols:["a\u028a"],id:9},{ipaSymbols:["\u0254\u026a"],id:10},{ipaSymbols:["a\u026a"],id:11},{ipaSymbols:["h"],id:12},{ipaSymbols:["\u0279"],id:13},{ipaSymbols:["l"],id:14},{ipaSymbols:["s","z"],id:15},{ipaSymbols:["\u0283","t\u0283","d\u0292","\u0292"],id:16},{ipaSymbols:["\xf0"],id:17},{ipaSymbols:["f","v"],id:18},{ipaSymbols:["d","t","n","\u03b8"],id:19},{ipaSymbols:["k","g","\u014b"],id:20},{ipaSymbols:["p","b","m"],id:21}];function b(e,o){const t=[],s=Math.round(1e3*o);return e&&0!==e.length?(e.forEach(((o,s)=>{const n=o.phoneme.toUpperCase(),i=function(e){if(null===e)return console.warn("[VisemeConversion] Received unmapped Hume SAPI phoneme, defaulting to Viseme 0 (silence)."),0;if("silence"===e)return 0;for(const o of v)if(o.ipaSymbols.includes(e))return o.id;return"e\u026a"===e?4:"o\u028a"===e?8:(console.warn("[VisemeConversion] Unmapped IPA symbol: '".concat(e,"', defaulting to Viseme 0 (silence).")),0)}(void 0!==A[n]?A[n]:null),a=Math.round(1e7*o.time);t.push({audioOffset:a,visemeId:i,isLastViseme:s===e.length-1})})),t.sort(((e,o)=>e.audioOffset-o.audioOffset)),console.log("[VisemeConversion] Converted Hume timeline to Azure visemes:",t),console.log("[VisemeConversion] Audio duration (ms):",s),{visemeEvents:t,audioDurationMs:s}):(console.warn("[VisemeConversion] Hume timeline is empty. Returning empty viseme events."),{visemeEvents:t,audioDurationMs:s})}let w;const V=async function(e){let o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"en-US-JennyNeural";return console.log('[VisemeService.ts synthesizeSpeechWithVisemes ENTRY_V6] Text: "'.concat(e,'", Voice: "').concat(o,'", Timestamp: ').concat(Date.now())),new Promise(((t,s)=>{console.log('[VisemeService.ts synthesizeSpeechWithVisemes PROMISE_CONSTRUCTOR_V6] Text: "'.concat(e,'", Timestamp: ').concat(Date.now()));const n=i().env.REACT_APP_AZURE_SPEECH_KEY,a=i().env.REACT_APP_AZURE_SPEECH_REGION;if(!n||!a)return console.error("[VisemeService.ts] Azure Speech Key or Region not found."),console.log('[VisemeService.ts REJECT_V6_NO_KEY_REGION] Text: "'.concat(e,'", Timestamp: ').concat(Date.now())),void s(new Error("Azure Speech Key or Region not configured."));try{w=y.SpeechConfig.fromSubscription(n,a),console.log("[VisemeService.ts synthesizeSpeechWithVisemes] SpeechConfig created:",w),w.speechSynthesisOutputFormat=y.SpeechSynthesisOutputFormat.Audio16Khz32KBitRateMonoMp3;const i='\n        <speak version="1.0" xmlns="http://www.w3.org/2001/10/synthesis" xmlns:mstts="http://www.w3.org/2001/mstts" xml:lang="en-US">\n          <voice name="'.concat(o,'">\n            <mstts:viseme type="FacialExpression"/>\n            ').concat(e,"\n          </voice>\n        </speak>");let r=new y.SpeechSynthesizer(w,null);console.log("[VisemeService.ts synthesizeSpeechWithVisemes] Synthesizer created. SSML to be used:",i);let l={standardVisemes:[],blendShapeFrames:[]},c=!1;const u=()=>{if(r){try{r.close()}catch(e){console.error("[VisemeService.ts cleanup] Error closing synthesizer:",e)}r=null}};r.visemeReceived=(e,o)=>{if(console.log("[VisemeService.ts visemeReceived] FIRING! Offset: ".concat(o.audioOffset/1e4,"ms, VisemeId: ").concat(o.visemeId)),o.animation&&""!==o.animation.trim()){console.log("[VisemeService.ts visemeReceived] Animation length: ".concat(o.animation.length)),console.log("[VisemeService.ts visemeReceived] Animation (first 100 chars): ".concat(o.animation.substring(0,100)));try{const e=JSON.parse(o.animation);if(e.BlendShapes&&void 0!==e.FrameIndex){const t=e.FrameIndex;e.BlendShapes.forEach(((s,n)=>{l.blendShapeFrames.push({frameIndex:t+n,shapes:s,audioOffset:o.audioOffset/1e4+n*(1e3/(e.FrameRate||60))})}))}else l.standardVisemes.push({visemeID:o.visemeId,audioOffset:o.audioOffset/1e4})}catch(t){console.error("[VisemeService.ts visemeReceived] Error parsing animation JSON:",t,"Animation string (on error):",o.animation),l.standardVisemes.push({visemeID:o.visemeId,audioOffset:o.audioOffset/1e4})}}else console.log("[VisemeService.ts visemeReceived] Animation is EMPTY or UNDEFINED."),l.standardVisemes.push({visemeID:o.visemeId,audioOffset:o.audioOffset/1e4})},r.speakSsmlAsync(i,(o=>{if(c)u();else{if(c=!0,o.reason===y.ResultReason.SynthesizingAudioCompleted){l.blendShapeFrames.sort(((e,o)=>e.frameIndex-o.frameIndex)),l.standardVisemes.sort(((e,o)=>e.audioOffset-o.audioOffset)),console.log("[VisemeService V6] Raw result.audioDuration:",o.audioDuration);const s=o.audioDuration/1e4;console.log("[VisemeService.ts speakSsmlAsync COMPLETED] Audio Duration: ".concat(o.audioDuration," (100ns units) = ").concat(s,"ms")),console.log('[VisemeService.ts RESOLVE_V6_SUCCESS] Text: "'.concat(e,'", audioDurationMs: ').concat(s,", Timestamp: ").concat(Date.now())),t({audioData:o.audioData,visemeData:l,audioDurationMs:s})}else if(o.reason===y.ResultReason.Canceled){const t=y.CancellationDetails.fromResult(o),n=void 0!==t.reason?y.CancellationReason[t.reason]:"UnknownReason";console.error("[VisemeService.ts speakSsmlAsync CANCELED] Reason: ".concat(n,", Details: ").concat(t.errorDetails,", ErrorCode: ").concat(t.ErrorCode)),console.log('[VisemeService.ts REJECT_V6_CANCELED] Text: "'.concat(e,'", Reason: ').concat(n,", Timestamp: ").concat(Date.now())),s("Synthesis Canceled: ".concat(n,". Details: ").concat(t.errorDetails,". ErrorCode: ").concat(t.ErrorCode))}else console.error("[VisemeService.ts speakSsmlAsync FAILED] Reason: ".concat(o.reason,", Details: ").concat(o.errorDetails)),console.log('[VisemeService.ts REJECT_V6_FAILED_RESULT] Text: "'.concat(e,'", Reason: ').concat(o.reason,", Timestamp: ").concat(Date.now())),s(new Error("Synthesis failed: ".concat(o.errorDetails||"Unknown error")));u()}}),(o=>{c||(c=!0,console.log('[VisemeService.ts REJECT_V6_ERROR_CALLBACK] Text: "'.concat(e,'", Error: ').concat(o,", Timestamp: ").concat(Date.now())),s(o)),u()}))}catch(r){console.error("[VisemeService.ts] Error initializing or starting synthesis:",r),console.log('[VisemeService.ts REJECT_V6_OUTER_CATCH] Text: "'.concat(e,'", Error: ').concat(r,", Timestamp: ").concat(Date.now())),s(r)}}))};var x=t(44414);const k=S.a.reduce(((e,o)=>(e[o]=0,e)),{}),R={0:{jawOpen:0,mouthClose:1,mouthPucker:0,mouthFunnel:0,mouthSmileLeft:0,mouthSmileRight:0},1:{jawOpen:.2,mouthShrugUpper:.1},2:{jawOpen:.6,mouthFunnel:.1},3:{jawOpen:.4,mouthFunnel:.3,mouthPucker:.2},4:{jawOpen:.3,mouthSmileLeft:.1,mouthSmileRight:.1},5:{jawOpen:.25,mouthShrugUpper:.2,tongueUp:.3},6:{jawOpen:.1,mouthSmileLeft:.4,mouthSmileRight:.4},7:{jawOpen:.15,mouthPucker:.6,mouthFunnel:.4},8:{jawOpen:.3,mouthPucker:.5,mouthFunnel:.3},9:{jawOpen:.5,mouthFunnel:.2,mouthPucker:.3},10:{jawOpen:.3,mouthFunnel:.2,mouthSmileLeft:.2},11:{jawOpen:.5,mouthSmileLeft:.3,mouthSmileRight:.3},12:{jawOpen:.1,mouthShrugUpper:.05},13:{jawOpen:.2,mouthPucker:.1,tongueUp:.4},14:{jawOpen:.25,tongueUp:.5,mouthSmileLeft:.1},15:{jawOpen:.05,mouthClose:.5,mouthSmileLeft:.2,mouthSmileRight:.2},16:{jawOpen:.15,mouthPucker:.4,mouthFunnel:.2},17:{jawOpen:.1,tongueUp:.2,mouthLowerDownLeft:.1,mouthLowerDownRight:.1},18:{jawOpen:.05,mouthLowerDownLeft:.3,mouthLowerDownRight:.3,mouthPressLeft:.2,mouthPressRight:.2},19:{jawOpen:.1,tongueUp:.6,mouthClose:.2},20:{jawOpen:.3,mouthShrugLower:.1,tongueUp:.2},21:{jawOpen:0,mouthClose:1,mouthPucker:.05}},E=S.a.reduce(((e,o)=>(e[o]=0,e)),{}),O=S.a.reduce(((e,o)=>("eyeBlinkLeft"!==o&&"eyeBlinkRight"!==o&&(e[o]=0),e)),{});const T=["/animations/M_Talking_Variations_001.glb","/animations/M_Talking_Variations_002.glb","/animations/M_Talking_Variations_003.glb","/animations/M_Talking_Variations_004.glb","/animations/M_Talking_Variations_005.glb","/animations/M_Talking_Variations_006.glb","/animations/M_Talking_Variations_007.glb","/animations/M_Talking_Variations_008.glb","/animations/M_Talking_Variations_009.glb","/animations/M_Talking_Variations_010.glb","/animations/talk.glb"],C=["/animations/M_Standing_Idle_001.glb","/animations/M_Standing_Idle_002.glb","/animations/M_Standing_Idle_Variations_001.glb","/animations/M_Standing_Idle_Variations_002.glb","/animations/M_Standing_Idle_Variations_003.glb","/animations/M_Standing_Idle_Variations_004.glb","/animations/M_Standing_Idle_Variations_005.glb","/animations/M_Standing_Idle_Variations_006.glb","/animations/M_Standing_Idle_Variations_007.glb","/animations/M_Standing_Idle_Variations_008.glb","/animations/M_Standing_Idle_Variations_009.glb","/animations/M_Standing_Idle_Variations_010.glb","/animations/idle.glb"],M={background:"rgba(0,0,0,0.5)",border:"1px solid white",borderRadius:"5px",padding:"8px 12px",color:"white",cursor:"pointer",fontSize:"0.9em",margin:"5px"},_=a.forwardRef(((e,o)=>{const{humeMessages:t,sendUserInputToVoice:n,voiceReadyState:i,isHumeVoicePlaying:y,disconnectVoice:A,connectVoice:v,humeConfigId:w}=e;console.log("[SimViewInternal FUNC_START] isHumeVoicePlaying from props: ".concat(e.isHumeVoicePlaying)),console.log("[SimViewInternal RENDER START] isHumeVoicePlaying from props:",e.isHumeVoicePlaying,"voiceReadyState:","number"===typeof e.voiceReadyState&&m.UT[e.voiceReadyState]?m.UT[e.voiceReadyState]:String(e.voiceReadyState));const{currentUser:_}=(0,g.A)(),{user:U,loading:D,error:I}=(0,p.Jd)(),{simulationId:L}=((0,r.Zp)(),(0,r.g)()),[j,H]=(e.avatarModelUrl||(null===U||void 0===U||U.avatarUrl),(0,a.useState)((()=>{const o={isMicOn:!1,isCameraOn:!0,isSoundOn:!0,isChatOpen:!1,messages:[],inputValue:"",isSpeaking:!1,isAzureAudioActive:!1,isHumeAudioActive:!1,currentEmotion:"neutral",statusMessage:"Initializing...",humeVoiceName:"KARL",azureVoiceName:"en-US-AvaNeural",currentVisemeShapes:O,manualBlendshapes:E,simulationData:null,error:null,isSending:!1,avatarUrl:e.avatarModelUrl||(null===U||void 0===U?void 0:U.avatarUrl)||"/bro.glb",isCameraEnabled:!0,isMicMuted:!1,showChat:!0,prosodyDrivenBlendshapes:k};return console.log("[SimViewInternal INITIAL_STATE] Calculated initialState.avatarUrl: ".concat(o.avatarUrl,", Using props.avatarModelUrl: ").concat(e.avatarModelUrl,", user?.avatarUrl: ").concat(null===U||void 0===U?void 0:U.avatarUrl)),o}))),z=(0,a.useRef)(j),P=(0,a.useCallback)((e=>{H((o=>(0,s.A)((0,s.A)({},o),{},{currentEmotion:e.name.toLowerCase()})))}),[H]),N="m3KaINwHsH55rJNO6zr2kIEAWvOimYeLTon3OriOXWJeCxCl",{sendVideoFrame:F,connectionState:B,lastError:W}=(0,f.S)(N,P,{isEmotionDetectionActive:j.isCameraOn,isVideoOn:j.isCameraOn});(0,a.useEffect)((()=>{console.log("[SimView HumeEmotionStream] Connection State:",B,"Last Error:",W),W&&H((e=>(0,s.A)((0,s.A)({},e),{},{statusMessage:"Emotion Stream Error: ".concat(W)})))}),[B,W]);const J=(0,a.useRef)(null),q=(0,a.useRef)(null),K=(0,a.useRef)([]),Y=(0,a.useRef)(null),G=(0,a.useRef)(null),X=(0,a.useRef)(null),Z=(0,a.useRef)(null),$=(0,a.useRef)(!1),Q=((0,a.useRef)(null),(0,a.useRef)(e.isHumeVoicePlaying));(0,a.useEffect)((()=>{z.current=j}),[j]),(0,a.useEffect)((()=>{console.log("[SimViewInternal AVATAR_URL_STATE] state.avatarUrl is now: ".concat(j.avatarUrl,". Initial props.avatarModelUrl was: ").concat(e.avatarModelUrl,". Current user?.avatarUrl: ").concat(null===U||void 0===U?void 0:U.avatarUrl))}),[j.avatarUrl,e.avatarModelUrl,U]),(0,a.useEffect)((()=>(console.log("[SimViewInternal MOUNT] Component did mount. Current props.avatarModelUrl: ".concat(e.avatarModelUrl,", Current state.avatarUrl: ").concat(j.avatarUrl)),()=>{console.log("[SimViewInternal UNMOUNT] Component will unmount. props.avatarModelUrl at unmount: ".concat(e.avatarModelUrl,", state.avatarUrl at unmount: ").concat(z.current.avatarUrl))})),[]);const ee=(0,a.useCallback)((e=>{H((o=>(0,s.A)((0,s.A)({},o),{},{statusMessage:"Avatar Error: ".concat(e.message)})))}),[]),oe=(0,a.useCallback)((()=>{H((e=>(0,s.A)((0,s.A)({},e),{},{statusMessage:"Avatar Loaded"})))}),[]);(0,a.useEffect)((()=>{Q.current=e.isHumeVoicePlaying,console.log("[SimViewEffect isHumeVoicePlayingRef] Updated isHumeVoicePlayingRef.current to: ".concat(Q.current," (raw isHumeVoicePlaying: ").concat(e.isHumeVoicePlaying,")"))}),[e.isHumeVoicePlaying]);const te=(0,a.useRef)(null),se=(0,a.useRef)(null),ne=(0,a.useRef)((0,c.A)()),ie=(0,a.useCallback)((()=>{Y.current&&(cancelAnimationFrame(Y.current),Y.current=null),H((e=>(0,s.A)((0,s.A)({},e),{},{currentVisemeShapes:O,isSpeaking:!1}))),console.log("[SimView stopVisemeAnimation] Viseme animation stopped and blendshapes reset to idle (allowing autonomous blinks).")}),[H,Y,E]),ae=(0,a.useCallback)((e=>{if(console.log("[SimView prepareVisemeFrames] Preparing viseme frames from data:",e),!e||!e.blendShapeFrames||0===e.blendShapeFrames.length)return console.warn("[SimView prepareVisemeFrames] No blendshape data received from Azure."),[];const o=e.blendShapeFrames.map((e=>{const o={};return S.a.forEach(((t,s)=>{o[t]=e.shapes[s]})),{time:e.audioOffset,shapes:o}}));return console.log("[SimView prepareVisemeFrames] Prepared ".concat(o.length," keyframes.")),o}),[]),re=(0,a.useCallback)(((e,o)=>{if(console.log("[SimView humeVisemeEventsToAnimationKeyframes] Called with ".concat(e.length," viseme events, duration: ").concat(o,"ms")),!e||0===e.length)return o>0?(console.log("[SimView humeVisemeEventsToAnimationKeyframes] No viseme events, creating silence bookends."),[{time:0,shapes:R[0]||E},{time:o/1e3,shapes:R[0]||E}]):(console.log("[SimView humeVisemeEventsToAnimationKeyframes] No viseme events and no duration, returning empty keyframes."),[]);const t=e.map((e=>({time:e.audioOffset/1e7,shapes:R[e.visemeId]||E}))),s=t.length>0?t[t.length-1].time:0,n=o/1e3;return(0===t.length||s<n)&&(0===t.length&&n>0&&t.push({time:0,shapes:R[0]||E}),t.push({time:n,shapes:R[0]||E})),console.log("[SimView humeVisemeEventsToAnimationKeyframes] Generated ".concat(t.length," keyframes.")),t}),[E]),le=(0,a.useCallback)((e=>{const o=(Date.now()-e)/1e3,t=K.current;if(!t||0===t.length)return console.log("[SimView animateVisemes] No frames to animate or animation ended."),void ie();let n=null;for(let s=0;s<t.length&&o>=t[s].time;s++)n=t[s];n&&(H((e=>(0,s.A)((0,s.A)({},e),{},{currentVisemeShapes:n.shapes}))),console.log("[SimView animateVisemes] Updated state.currentVisemeShapes with:",n.shapes));if(o>(t.length>0?t[t.length-1].time:0)+.5||!n&&o>.1&&t.length>0)return console.log("[SimView animateVisemes] Animation sequence likely complete or past last frame time."),void ie();Y.current=requestAnimationFrame((()=>le(e)))}),[H,ie,K,Y]),ce=(0,a.useCallback)((()=>{if(console.log("[SimView startVisemeAnimation] CALLED. Frame count:",K.current.length),K.current&&K.current.length>0){console.log("[SimView startVisemeAnimation] Starting viseme animation with frames:",K.current);const e=Date.now();Y.current&&cancelAnimationFrame(Y.current),le(e)}else console.log("[SimView startVisemeAnimation] No viseme frames to animate."),ie()}),[le,ie,Y,K]),ue=((0,a.useCallback)((async(e,o)=>{console.log("[SimView playHumeOutputWithVisemes] Called with audio URL and timeline."),H((e=>(0,s.A)((0,s.A)({},e),{},{isAzureAudioActive:!1,isHumeAudioActive:!0}))),J.current&&(J.current.pause(),J.current.src=""),ie(),q.current||(q.current=new Audio,q.current.addEventListener("ended",(()=>{console.log("[SimView HumeAudio] Playback ended."),ie(),H((e=>(0,s.A)((0,s.A)({},e),{},{isSpeaking:!1,isHumeAudioActive:!1})))})),q.current.addEventListener("error",(e=>{console.error("[SimView HumeAudio] Audio playback error:",e),ie(),H((e=>(0,s.A)((0,s.A)({},e),{},{isSpeaking:!1,isHumeAudioActive:!1})))}))),q.current.src=e,q.current.load();try{await q.current.play(),console.log("[SimView HumeAudio] Playback started."),H((e=>(0,s.A)((0,s.A)({},e),{},{isSpeaking:!0})));const e=q.current.duration;(isNaN(e)||0===e)&&console.warn("[SimView playHumeOutputWithVisemes] Hume audio duration not available or zero after play. Visemes might be incorrect."),console.log("[SimView playHumeOutputWithVisemes] Hume audio duration: ".concat(e,"s"));const t=b(o,e),n=re(t.visemeEvents,t.audioDurationMs);n&&n.length>0?(K.current=n,ce()):console.log("[SimView playHumeOutputWithVisemes] No keyframes generated for Hume output. Lip sync will not occur.")}catch(t){console.error("[SimView playHumeOutputWithVisemes] Error playing Hume audio or processing visemes:",t),ie(),H((e=>(0,s.A)((0,s.A)({},e),{},{isSpeaking:!1,isHumeAudioActive:!1})))}}),[ie,ce,re,E,le]),(0,a.useCallback)((e=>{console.log("[SimView handleHumeSpeakingStarted] Called. Setting isSpeaking to true."),H((e=>(0,s.A)((0,s.A)({},e),{},{isSpeaking:!0,statusMessage:"Bot Speaking (Hume)..."})))}),[H])),me=(0,a.useCallback)((()=>{console.log("[SimView handleHumeSpeakingStopped] Called."),z.current.isAzureAudioActive?console.log("[SimView handleHumeSpeakingStopped] Azure audio is active, not stopping visemes or changing speaking state from here."):(console.log("[SimView handleHumeSpeakingStopped] Azure audio not active. Stopping visemes and setting isSpeaking to false."),ie(),H((e=>(0,s.A)((0,s.A)({},e),{},{isSpeaking:!1,statusMessage:"Idle"}))))}),[ie,H,z]),de=(0,a.useCallback)((()=>{console.log("[SimView handleAzureAudioEnded] CALLED."),console.log("[SimView handleAzureAudioEnded] Setting isAzurePlayingRef.current = false"),$.current=!1,ie(),H((e=>(0,s.A)((0,s.A)({},e),{},{isAzureAudioActive:!1}))),J.current&&J.current.src.startsWith("blob:")&&(URL.revokeObjectURL(J.current.src),J.current.src="",J.current.srcObject=null,console.log("[SimView handleAzureAudioEnded] Revoked blob URL and reset azureAudioRef src."))}),[ie,H,J]),ge=(0,a.useCallback)((e=>{const o=e.target;console.error("[SimView handleAzureAudioError] Azure audio playback error:",o.error),ie(),H((e=>(0,s.A)((0,s.A)({},e),{},{isAzureAudioActive:!1,statusMessage:"Error playing Azure audio."}))),J.current&&J.current.src.startsWith("blob:")&&(URL.revokeObjectURL(J.current.src),J.current.src="",J.current.srcObject=null,console.log("[SimView handleAzureAudioError] Revoked blob URL and reset azureAudioRef src after error."))}),[ie,H,J]),pe=(0,a.useCallback)((async(e,o)=>{if(console.log('[SimView generateAndAnimateVisemesFromText] Test function called with text: "'.concat(e,'", voice: ').concat(o)),J.current)try{var t;H((e=>(0,s.A)((0,s.A)({},e),{},{statusMessage:"Testing Visemes...",isSpeaking:!0,isAzureAudioActive:!0}))),J.current.paused||(J.current.pause(),J.current.currentTime=0);const a=await V(e,o||z.current.azureVoiceName);if(console.log("[SimView generateAndAnimateVisemesFromText] Full serviceResult from VisemeService:",JSON.stringify(a,null,2)),null!==a&&void 0!==a&&null!==(t=a.visemeData)&&void 0!==t&&t.blendShapeFrames&&a.visemeData.blendShapeFrames.length>0){console.log("[SimView generateAndAnimateVisemesFromText] First 3 blendShapeFrames from serviceResult:");for(let o=0;o<Math.min(3,a.visemeData.blendShapeFrames.length);o++){var n;console.log("  Frame ".concat(o,": audioOffset=").concat(a.visemeData.blendShapeFrames[o].audioOffset,", shapes=").concat(JSON.stringify(null===(n=a.visemeData.blendShapeFrames[o].shapes)||void 0===n?void 0:n.slice(0,5)),"..."))}const e=a.visemeData.blendShapeFrames.length-1;var i;if(e>=0)console.log("  Last Frame ".concat(e,": audioOffset=").concat(a.visemeData.blendShapeFrames[e].audioOffset,", shapes=").concat(JSON.stringify(null===(i=a.visemeData.blendShapeFrames[e].shapes)||void 0===i?void 0:i.slice(0,5)),"..."))}else console.log("[SimView generateAndAnimateVisemesFromText] serviceResult.visemeData.blendShapeFrames is missing, empty, or not an array.");if(a&&"audioDurationMs"in a?console.log("[SimView generateAndAnimateVisemesFromText] serviceResult.audioDurationMs:",a.audioDurationMs):console.log("[SimView generateAndAnimateVisemesFromText] serviceResult.audioDurationMs is not available."),a&&a.audioData&&a.visemeData){const e=ae(a.visemeData);e&&e.length>0?(K.current=e,ce()):ie();const o=new Blob([a.audioData],{type:"audio/mpeg"}),t=URL.createObjectURL(o);J.current.srcObject=null,J.current.src=t,J.current.play().catch((e=>{console.error("[SimView generateAndAnimateVisemesFromText] Error playing test audio:",e),de()}))}else console.error("[SimView generateAndAnimateVisemesFromText] Failed to get audio/viseme data for test."),de()}catch(a){console.error("[SimView generateAndAnimateVisemesFromText] Error in test function:",a),de()}else console.error("[SimView generateAndAnimateVisemesFromText] azureAudioRef.current is null.")}),[V,ae,ce,ie,de,H,z,J,K]),he=(0,a.useCallback)((async e=>{if(console.log("[SimView processAndPlayAzureSpeech] CALLED. Text:",e),!J.current)return console.error("[SimView processAndPlayAzureSpeech] azureAudioRef.current is null. Cannot play Azure audio."),void de();H((e=>(0,s.A)((0,s.A)({},e),{},{isSpeaking:!0,isAzureAudioActive:!0,statusMessage:"Bot Speaking (Azure)..."}))),J.current&&!J.current.paused&&(console.warn("[SimView processAndPlayAzureSpeech] Azure audio player (azureAudioRef) was active. Stopping existing playback."),J.current.pause(),J.current.currentTime=0);try{var o,t,n,i,a;console.log("[SimView processAndPlayAzureSpeech] Attempting to synthesize with voice:",j.azureVoiceName);const s=j.azureVoiceName,c=await V(e,s);if(console.log("[SimView processAndPlayAzureSpeech] serviceResult (summary):",JSON.stringify(c?{audioDataLength:null===(o=c.audioData)||void 0===o?void 0:o.byteLength,blendShapeFramesLength:null===(t=c.visemeData)||void 0===t||null===(n=t.blendShapeFrames)||void 0===n?void 0:n.length,standardVisemesLength:null===(i=c.visemeData)||void 0===i||null===(a=i.standardVisemes)||void 0===a?void 0:a.length}:null)),c&&c.audioData&&c.visemeData){var r,l;console.log("[SimView processAndPlayAzureSpeech] VisemeData received from Azure. BlendShapeFrames count:",null===(r=c.visemeData.blendShapeFrames)||void 0===r?void 0:r.length,"StandardVisemes count:",null===(l=c.visemeData.standardVisemes)||void 0===l?void 0:l.length,". Now calling prepareVisemeFrames.");const e=ae(c.visemeData);console.log("[SimView processAndPlayAzureSpeech] preparedFrames:",e),e&&e.length>0?(K.current=e,console.log("[SimView processAndPlayAzureSpeech] visemeFramesRef.current SET. Length:",K.current.length)):(K.current=[],console.log("[SimView processAndPlayAzureSpeech] preparedFrames EMPTY or invalid. visemeFramesRef.current set to empty array."));const o=new Blob([c.audioData],{type:"audio/mpeg"}),t=URL.createObjectURL(o);J.current.srcObject=null,J.current.src=t,J.current.play().then((()=>{console.log("[SimView processAndPlayAzureSpeech] Azure audio playback REALLY STARTED."),K.current&&K.current.length>0?(console.log("[SimView processAndPlayAzureSpeech] Calling startVisemeAnimation after audio play().then()"),ce()):(console.log("[SimView processAndPlayAzureSpeech] No viseme frames to animate after audio play().then(), stopping animation."),ie())})).catch((e=>{console.error("[SimView processAndPlayAzureSpeech] Error playing Azure audio:",e),de()})),console.log("[SimView processAndPlayAzureSpeech] Azure audio playback INITIATED. Setting isAzurePlayingRef.current = true"),$.current=!0}else console.error("[SimView processAndPlayAzureSpeech] Failed to synthesize Azure speech or missing audio data. Result:",c),de()}catch(c){console.error("[SimView processAndPlayAzureSpeech] Error during Azure TTS synthesis:",c),de()}}),[V,J,me,ae,ce,ie,Q,de,K]);(0,a.useEffect)((()=>{if(0===e.humeMessages.length)return;const o=e.humeMessages[e.humeMessages.length-1];if(o){if("user_message"===o.type){if(X.current&&o.receivedAt<=X.current)return}else if("assistant_message"===o.type&&o.id&&o.id===Z.current)return;switch("assistant_message"===o.type&&o.models&&console.log("[Hume EVI Message Inspector] Assistant Message with Models:",JSON.stringify(o,null,2)),o.type){case"user_message":{if(!o.message||"string"!==typeof o.message.content||"user"!==o.message.role){console.warn("[SimView] User message content/role issue or type mismatch. Skipping. Full message:",JSON.stringify(o,null,2));break}console.log("[SimView] user_message: Role: ".concat(o.message.role,". User text:"),o.message.content);const e={id:(0,c.A)(),text:o.message.content,sender:"user",timestamp:o.receivedAt};H((o=>(0,s.A)((0,s.A)({},o),{},{messages:[...o.messages,e]}))),X.current=o.receivedAt;break}case"assistant_message":{var t,n,i,a;if(console.log("[SimView] ENTERING assistant_message case block. Message ID:",o.id),null!==(t=o.models)&&void 0!==t&&null!==(n=t.prosody)&&void 0!==n&&n.scores?console.log("[SimView] DETECTED PROSODY SCORES:",JSON.stringify(o.models.prosody.scores,null,2)):console.log("[SimView] Assistant Message, but NO prosody.scores. Models:",JSON.stringify(o.models,null,2)),!o.message||"string"!==typeof o.message.content||"assistant"!==o.message.role){console.warn("[SimView] Assistant message content/role issue or type mismatch. Skipping. Full message:",JSON.stringify(o,null,2));break}console.log("[SimView] assistant_message: Role: ".concat(o.message.role,". Assistant text:"),o.message.content);const r={id:o.id||(0,c.A)(),text:o.message.content,sender:"bot",timestamp:o.receivedAt};let u=[{name:"neutral",score:1}],m="default (neutral)";if(null!==(i=o.models)&&void 0!==i&&null!==(a=i.prosody)&&void 0!==a&&a.scores&&Array.isArray(o.models.prosody.scores)&&o.models.prosody.scores.length>0){const e=o.models.prosody.scores.filter((e=>"string"===typeof e.name&&"number"===typeof e.score));e.length>0?(u=e,m="prosody.scores"):(console.warn("[SimView] Hume prosody.scores present but items do not match Emotion structure:",JSON.stringify(o.models.prosody.scores)),m="prosody.scores (invalid structure)")}else console.log("[SimView] No prosody.scores found in Hume message. Using default neutral emotion.");console.log("[SimView] Extracted emotions from Hume message (source: ".concat(m,"):"),JSON.stringify(u)),H((o=>{const t=u.reduce(((e,o)=>(e[o.name]=o.score,e)),{});console.log("[SimView assistant_message] newEmotions feeding into blendshapes:",JSON.stringify(u)),console.log("[SimView assistant_message] prosodyScoresForBlendshapes for prosodyToBlendshapes:",JSON.stringify(t));const n=(0,l.l)(t);return console.log("[SimView assistant_message] newProsodyBlendshapes from prosodyToBlendshapes (count: ".concat(Object.keys(n).length,"):"),JSON.stringify(n)),(0,s.A)((0,s.A)({},o),{},{messages:[...o.messages,r],currentDetectedEmotions:u,isSpeaking:e.isHumeVoicePlaying,statusMessage:e.isHumeVoicePlaying?"Bot Speaking (Hume EVI)":o.statusMessage.includes("Azure")?o.statusMessage:"Bot Idle",prosodyDrivenBlendshapes:n})})),o.message.content,o.id&&(Z.current=o.id);break}case"assistant_end":console.log("[SimView] assistant_end message received:",o);break;case"error":console.error("[SimView] WebSocketError message received:",JSON.stringify(o,null,2)),H((e=>(0,s.A)((0,s.A)({},e),{},{statusMessage:"Hume EVI Error: ".concat(o.message)})));break;case"chat_metadata":console.log("[SimView] chat_metadata message received:",o);break;case"user_interruption":console.log("[SimView] user_interruption message received:",o),J.current&&(J.current.pause(),J.current.src=""),ie(),H((e=>(0,s.A)((0,s.A)({},e),{},{isSpeaking:!1,isAzureAudioActive:!1,statusMessage:"User interrupted bot."})));break;case"tool_call":console.log("[SimView] tool_call message received:",o);break;case"tool_response":console.log("[SimView] tool_response message received:",o);break;case"tool_error":console.log("[SimView] tool_error message received:",o);break;default:console.log("[SimView] Received unhandled or unexpected message type:",o.type,"Full message:",JSON.stringify(o,null,2))}return()=>{G.current&&(clearTimeout(G.current),G.current=null)}}}),[e.humeMessages,he,e.isHumeVoicePlaying]),(0,a.useEffect)((()=>(e.isHumeVoicePlaying?(G.current&&(clearTimeout(G.current),G.current=null),ue()):z.current.isSpeaking&&(G.current&&clearTimeout(G.current),G.current=setTimeout((()=>{console.log("[SimView useEffect HumeVoicePlaying] Debounced: Hume stopped, calling handleHumeSpeakingStopped."),me()}),250)),()=>{G.current&&(clearTimeout(G.current),G.current=null)})),[e.isHumeVoicePlaying,ue,me,z,G]);const Se=(0,a.useCallback)((e=>{H((o=>(0,s.A)((0,s.A)({},o),{},{inputValue:e.target.value})))}),[H]),fe=(0,a.useCallback)((async o=>{o&&o.preventDefault();const t=z.current.inputValue.trim();if(!t)return;const n={id:(0,c.A)(),text:t,sender:"user",timestamp:new Date};H((e=>(0,s.A)((0,s.A)({},e),{},{messages:[...e.messages,n],inputText:""}))),console.log("[SimView] Sending user message to Hume EVI:",t),e.sendUserInputToVoice?e.sendUserInputToVoice(t):console.warn("[SimView] sendUserInput is not available. Message not sent to Hume.")}),[H,e.sendUserInputToVoice,e.simulationId,_,z,ne]),ye=((0,a.useCallback)((e=>{console.log("[SimView] Avatar Emotion Detected:",e)}),[]),(0,a.useCallback)((e=>{console.error("[SimView] Avatar Error:",e),console.error("[SimView] Full avatar error object:",e);const o=e instanceof Error?e.message:String(e);H((e=>(0,s.A)((0,s.A)({},e),{},{statusMessage:"Avatar error: ".concat(o)})))}),[H]),(0,a.useCallback)((()=>{console.log("[SimView] Avatar Loaded successfully."),H((e=>(0,s.A)((0,s.A)({},e),{},{statusMessage:"Avatar loaded."})))}),[H]),(0,a.useCallback)((()=>{H((e=>(0,s.A)((0,s.A)({},e),{},{isCameraEnabled:!e.isCameraEnabled})))}),[H]),(0,a.useCallback)((()=>{H((o=>{console.log("[SimView toggleMic] Clicked. Current voiceReadyState: ".concat(function(e){switch(e){case m.UT.IDLE:return"IDLE";case m.UT.CONNECTING:return"CONNECTING";case m.UT.OPEN:return"OPEN";case m.UT.CLOSED:return"CLOSED";default:return console.warn("[getVoiceReadyStateName] Encountered unhandled or unknown state value: ".concat(e)),"UNKNOWN_STATE_(".concat(String(e),")")}}(e.voiceReadyState),", current isMicMuted (before toggle): ").concat(o.isMicMuted));const t=!o.isMicMuted;return t?(console.log("[SimView toggleMic] Mic muted. Disconnecting Hume Voice."),e.disconnectVoice()):(console.log("[SimView toggleMic] Mic unmuted. Attempting to connect Hume Voice."),console.log("[SimView toggleMic] Current state values - humeAccessToken: ".concat(z.current.humeAccessToken?"SET":"NOT SET",", humeConfigId: ").concat(z.current.humeConfigId||"NOT SET (uses default from Provider)")),e.connectVoice().then((()=>{console.log("[SimView toggleMic] Hume Voice connect() promise resolved successfully.")})).catch((e=>{console.error("[SimView toggleMic] Error connecting Hume Voice:",e),H((o=>(0,s.A)((0,s.A)({},o),{},{statusMessage:"Error connecting mic: ".concat(e.message)})))}))),(0,s.A)((0,s.A)({},o),{},{isMicMuted:t,isMicOn:!t,statusMessage:t?"Mic muted.":"Mic unmuted, attempting connection..."})}))}),[H,e.connectVoice,e.disconnectVoice,z,e.voiceReadyState])),Ae=(0,a.useCallback)((()=>{H((e=>(0,s.A)((0,s.A)({},e),{},{showChat:!e.showChat})))}),[H]),ve=(0,a.useCallback)((()=>{H((e=>{const o=!e.isSoundOn;return J.current&&(J.current.muted=!o),(0,s.A)((0,s.A)({},e),{},{isSoundOn:o,statusMessage:o?"Sound unmuted.":"Sound muted."})}))}),[H,J]),be=(0,a.useCallback)((()=>{console.log("[SimViewInternal] forceStopAllAudio called."),J.current&&!J.current.paused&&(J.current.pause(),J.current.src&&J.current.src.startsWith("blob:")&&URL.revokeObjectURL(J.current.src),J.current.src=""),ie(),H((e=>(0,s.A)((0,s.A)({},e),{},{isAzureAudioActive:!1,statusMessage:"Local audio and speech visualization stopped."})))}),[J,ie,H]);(0,a.useImperativeHandle)(o,(()=>({forceStopHumeSpeaking:()=>{console.log("[SimViewInternal forceStopHumeSpeaking] Imperatively called."),J.current&&!J.current.paused&&(J.current.pause(),J.current.src&&J.current.src.startsWith("blob:")&&URL.revokeObjectURL(J.current.src),J.current.src=""),ie(),H((e=>(0,s.A)((0,s.A)({},e),{},{isAzureAudioActive:!1,statusMessage:e.isAzureAudioActive?"Azure speech stopped via external call.":"Hume speech stop requested externally."})))}})),[J,ie,H]);let we=j.isSpeaking,Ve=j.statusMessage;return j.isAzureAudioActive||(e.isHumeVoicePlaying?(we=!0,Ve="Bot Speaking (Hume EVI)"):(we=!1,Ve="Idle")),console.log("[SimViewInternal BEFORE RETURN] isHumeVoicePlaying:",e.isHumeVoicePlaying,"Current state.isSpeaking:",j.isSpeaking,"DerivedIsSpeaking:",we,"DerivedStatusMessage:",Ve),(0,x.jsxs)("div",{className:"simulation-view",style:{display:"flex",height:"100vh",flexDirection:"column",background:"#282c34"},children:[(0,x.jsxs)("div",{className:"status-bar",style:{padding:"10px",background:"#20232a",color:"white",textAlign:"center",fontSize:"0.9em",flexShrink:0},children:["Status: ",Ve," | Hume: ","number"===typeof e.voiceReadyState&&m.UT[e.voiceReadyState]?m.UT[e.voiceReadyState]:String(e.voiceReadyState)," | Speaking: ",we?"Yes":"No"," | Hume Playing: ",e.isHumeVoicePlaying?"Yes":"No"]}),(0,x.jsx)(d.TestModeToggle,{onMockMessage:e=>{if(console.log("\ud83e\uddea Mock message received:",e),e.prosody){const o=e.prosody.reduce(((e,o)=>(e[o.name]=o.score,e)),{}),t=(0,l.l)(o);H((e=>(0,s.A)((0,s.A)({},e),{},{prosodyDrivenBlendshapes:t})))}if(e.timeline){const e={jawOpen:.4,mouthFunnel:.3};H((o=>(0,s.A)((0,s.A)({},o),{},{currentVisemeShapes:e})))}"audio_output"===e.type&&(H((e=>(0,s.A)((0,s.A)({},e),{},{isSpeaking:!0}))),setTimeout((()=>{H((e=>(0,s.A)((0,s.A)({},e),{},{isSpeaking:!1,currentVisemeShapes:{}})))}),2e3))},onMockProsody:e=>{console.log("\ud83e\uddea Mock prosody received:",e);const o=e.reduce(((e,o)=>(e[o.name]=o.score,e)),{}),t=(0,l.l)(o);H((e=>(0,s.A)((0,s.A)({},e),{},{prosodyDrivenBlendshapes:t})))},onMockVisemes:e=>{console.log("\ud83e\uddea Mock visemes received:",e),H((o=>(0,s.A)((0,s.A)({},o),{},{currentVisemeShapes:e})))}}),(0,x.jsxs)("div",{style:{display:"flex",flexGrow:1,position:"relative",overflow:"hidden"},children:[(0,x.jsxs)("div",{className:"avatar-container",style:{flexGrow:1,display:"flex",justifyContent:"center",alignItems:"center",position:"relative",background:"#333740"},children:[(console.log("[SimViewInternal RENDER] Passing DERIVED isSpeaking to EmotionDrivenAvatar:",we),null),(0,x.jsx)(h.default,{directBlendshapes:(0,s.A)((0,s.A)({},j.manualBlendshapes),j.prosodyDrivenBlendshapes),ref:se,avatarUrl:j.avatarUrl,isSpeaking:we,visemeData:j.currentVisemeShapes,currentEmotion:j.currentEmotion,idleShapes:O,detectedEmotions:j.currentEmotion?[{name:j.currentEmotion,score:1}]:[],cameraEnabled:j.isCameraEnabled,talkAnimationPaths:T,idleAnimationPaths:C,onError:ee,onLoad:oe},j.avatarUrl),(0,x.jsx)("button",{onClick:()=>pe("Hello world, this is a test.",j.azureVoiceName||"en-US-JennyNeural"),style:(0,s.A)((0,s.A)({},M),{},{position:"absolute",top:"10px",left:"10px",zIndex:10}),children:"Test Visemes"})]}),j.showChat&&(0,x.jsxs)("div",{className:"chat-ui",style:{width:"350px",minWidth:"300px",background:"rgba(30, 33, 40, 0.95)",color:"white",display:"flex",flexDirection:"column",padding:"15px",borderLeft:"1px solid #4f5461",boxSizing:"border-box",position:"absolute",right:0,top:0,bottom:0,zIndex:5,transition:"transform 0.3s ease-in-out",transform:"translateX(0%)"},children:[(0,x.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"15px",flexShrink:0},children:[(0,x.jsx)("h3",{style:{margin:0,fontSize:"1.2em"},children:"Conversation"}),(0,x.jsx)("button",{onClick:Ae,style:{background:"none",border:"none",color:"#aaa",cursor:"pointer",fontSize:"1.5em",padding:"5px"},children:"X"})]}),(0,x.jsxs)("div",{className:"messages-area",style:{flexGrow:1,overflowY:"auto",marginBottom:"15px",paddingRight:"10px"},children:[j.messages.map((e=>(0,x.jsxs)("div",{className:"message ".concat(e.sender),style:{marginBottom:"12px",padding:"10px 15px",borderRadius:"18px",maxWidth:"85%",alignSelf:"user"===e.sender?"flex-end":"flex-start",background:"user"===e.sender?"#007bff":"#495057",color:"white",textAlign:"user"===e.sender?"right":"left",marginLeft:"bot"===e.sender?"0":"auto",marginRight:"user"===e.sender?"0":"auto",wordWrap:"break-word",fontSize:"0.95em"},children:[e.text,e.emotion&&(0,x.jsxs)("em",{style:{fontSize:"0.8em",display:"block",opacity:.7,marginTop:"4px"},children:["(",e.emotion,")"]})]},e.id))),(0,x.jsx)("div",{ref:te})]}),(0,x.jsx)("audio",{ref:J,onEnded:de,onError:ge,style:{display:"none"}}),(0,x.jsxs)("form",{onSubmit:fe,style:{display:"flex",marginTop:"auto",paddingTop:"10px",borderTop:"1px solid #4f5461",flexShrink:0},children:[(0,x.jsx)("input",{type:"text",value:j.inputValue,onChange:Se,placeholder:"Type your message...",style:{flexGrow:1,padding:"12px 18px",border:"1px solid #555",borderRadius:"25px",marginRight:"10px",outline:"none",color:"#e0e0e0",background:"#3a3f47",fontSize:"1em"}}),(0,x.jsx)("button",{type:"submit",disabled:!j.inputValue.trim(),style:{background:j.inputValue.trim()?"#007bff":"#555",color:"white",border:"none",borderRadius:"50%",width:"48px",height:"48px",display:"flex",alignItems:"center",justifyContent:"center",cursor:j.inputValue.trim()?"pointer":"not-allowed",opacity:j.inputValue.trim()?1:.6,transition:"background-color 0.2s ease"},children:">"})]})]}),!j.showChat&&(0,x.jsx)("button",{onClick:Ae,style:{position:"absolute",bottom:"30px",right:"30px",background:"#007bff",color:"white",border:"none",borderRadius:"50%",width:"60px",height:"60px",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",boxShadow:"0 4px 12px rgba(0,0,0,0.3)",zIndex:10,transition:"transform 0.2s ease"},onMouseOver:e=>e.currentTarget.style.transform="scale(1.1)",onMouseOut:e=>e.currentTarget.style.transform="scale(1)",children:"Chat"})]}),(0,x.jsxs)("div",{className:"controls-bar",style:{display:"flex",justifyContent:"center",alignItems:"center",padding:"10px",background:"#20232a",flexShrink:0,gap:"10px"},children:[(0,x.jsxs)("button",{onClick:ye,style:M,title:j.isMicMuted?"Unmute Microphone":"Mute Microphone",children:[j.isMicMuted?(0,x.jsx)(u.$j$,{}):(0,x.jsx)(u.i0t,{})," ",j.isMicMuted?"Mic Off":"Mic On"]}),(0,x.jsxs)("button",{onClick:ve,style:M,title:j.isSoundOn?"Mute Sound":"Unmute Sound",children:[j.isSoundOn?(0,x.jsx)(u.pPd,{}):(0,x.jsx)(u.FZ2,{})," ",j.isSoundOn?"Sound On":"Sound Off"]}),(0,x.jsxs)("button",{onClick:be,style:(0,s.A)((0,s.A)({},M),{},{background:"#dc3545"}),title:"Force stop all audio and speech",children:[(0,x.jsx)(u.mal,{})," Stop All Audio"]})]})]})})),U=e=>{const[o,t]=(0,a.useState)("Hume Audio: Idle"),s=(0,a.useRef)(null),n=a.useMemo((()=>{const e="m3KaINwHsH55rJNO6zr2kIEAWvOimYeLTon3OriOXWJeCxCl";return e||""}),[]),i="bfd6db39-f0ea-46c3-a64b-e902d8cec212",{messages:r,sendUserInput:l,readyState:c,isPlaying:u,disconnect:d,connect:g,status:p}=(0,m.c0)();console.log("[SimulationView useVoice] isHumeVoicePlaying:",u,"status:",p);const h=(0,a.useCallback)((()=>{console.log("[Hume EVI] Connection opened via VoiceProvider.")}),[]),S=(0,a.useMemo)((()=>({type:"apiKey",value:n})),[n]),f=(0,a.useCallback)((e=>{const o=e.type;switch(console.log("[Hume EVI] Message received - Type: ".concat(o)),o){case"assistant_message":if(console.log("[Hume EVI] Assistant Message details:",e),e.models){const o=e.models;o.face&&o.face.predictions&&console.log("[Hume EVI] Face model predictions:",o.face.predictions)}break;case"user_interruption":console.log("[Hume EVI] User Interruption details:",e);break;case"tool_call":console.log("[Hume EVI] Tool Call details:",e);break;case"tool_response":console.log("[Hume EVI] Tool Response details:",e);break;case"tool_error":console.error("[Hume EVI] Tool Error details:",e)}}),[]),y=(0,a.useCallback)((e=>{var o;console.log("[Hume EVI] Connection closed via VoiceProvider. Code:",e.code,"Reason:",e.reason,"WasClean:",e.wasClean),null===(o=s.current)||void 0===o||o.forceStopHumeSpeaking()}),[]),A=(0,a.useCallback)((e=>{let o="[Hume EVI] VoiceProvider error - Type: ".concat(e.type,", Code: ").concat(e.code,", Message: ").concat(e.message);console.error(o,e)}),[]);return n||console.warn("[SimulationView] Hume API Key is not available. VoiceProvider will likely fail to connect."),console.log('[SimulationView] Attempting to connect VoiceProvider with API Key: "'.concat(n,'" and Config ID: "').concat(i,'"')),console.log("[SimulationView] voiceAuth object being passed:",S),(0,x.jsxs)(x.Fragment,{children:[(0,x.jsxs)("div",{style:{padding:"8px",backgroundColor:"#ff69b4",color:"white",textAlign:"center",fontWeight:"bold",fontSize:"1.1em",zIndex:9999,position:"relative"},children:["HUME AUDIO EVENT STATUS: ",o]}),(0,x.jsx)(m.QP,{onAudioStart:()=>{console.log("[Hume EVI VoiceProvider] onAudioStart triggered"),t("Hume Audio: STARTED")},onAudioEnd:()=>{console.log("[Hume EVI VoiceProvider] onAudioEnd triggered"),t("Hume Audio: ENDED")},auth:S,configId:i,debug:!0,onOpen:h,onMessage:f,onClose:y,onError:A,children:(0,x.jsx)(_,{ref:s,simulationId:e.simulationId,avatarModelUrl:e.avatarModelUrl,humeMessages:r,sendUserInputToVoice:l,voiceReadyState:c,isHumeVoicePlaying:u,disconnectVoice:d,connectVoice:g,humeConfigId:i})})]})}},42250:()=>{},44573:()=>{},56443:(e,o,t)=>{"use strict";t.r(o),t.d(o,{TestModeToggle:()=>a});var s=t(9950),n=t(52490),i=t(44414);const a=e=>{let{onMockMessage:o,onMockProsody:t,onMockVisemes:a}=e;const[l,c]=(0,s.useState)(!1),[u,m]=(0,s.useState)(!1),[d,g]=(0,s.useState)(null),p=(0,s.useCallback)((()=>{if(l)console.log("\ud83e\uddea Disabling Test Mode"),d&&d.stop(),g(null),c(!1),m(!1);else{console.log("\ud83e\uddea Enabling Test Mode - Using Mock Hume Data");const e=new n.MZ((e=>{if(console.log("\ud83c\udfad Mock message received:",e),o&&o(e),e.prosody&&t&&t(e.prosody),e.timeline&&a){const o=e.timeline.reduce(((e,o)=>{if("phoneme"===o.type)switch(o.value){case"eh":case"ae":e.jawOpen=0;break;case"ow":case"aw":e.mouthFunnel=.7;break;case"iy":case"ih":e.mouthSmileLeft=.3,e.mouthSmileRight=.3;break;default:e.jawOpen=Math.max(e.jawOpen||0,0)}return e}),{});a(o)}}));g(e),e.start(),c(!0),m(!0)}}),[l,d,o,t,a]),h=(0,s.useCallback)((e=>{if(t){const o=n.Xx[e];o&&(console.log("\ud83e\uddea Testing emotion set: ".concat(e),o),t(o))}}),[t]);return(0,i.jsxs)("div",{style:{position:"fixed",top:"10px",left:"10px",background:"rgba(0,0,0,0.9)",color:"white",padding:"10px",borderRadius:"8px",zIndex:1e3,fontSize:"12px",width:u?"280px":"160px",maxHeight:u?"70vh":"auto",overflowY:u?"auto":"hidden",transition:"all 0.3s ease",border:"1px solid rgba(255,255,255,0.2)"},children:[(0,i.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:"8px"},children:[(0,i.jsx)("h4",{style:{margin:"0",fontSize:"13px"},children:"\ud83e\uddea Test Mode"}),l&&(0,i.jsx)("button",{onClick:()=>m(!u),style:{background:"transparent",border:"1px solid rgba(255,255,255,0.3)",color:"white",padding:"2px 6px",borderRadius:"3px",cursor:"pointer",fontSize:"10px"},children:u?"\u25b2":"\u25bc"})]}),(0,i.jsx)("button",{onClick:p,style:{background:l?"#ff4444":"#44ff44",color:"white",border:"none",padding:"6px 10px",borderRadius:"4px",cursor:"pointer",width:"100%",fontSize:"11px",marginBottom:l&&u?"10px":"0"},children:l?"\ud83d\uded1 Stop":"\u25b6\ufe0f Start Test"}),l&&u&&(0,i.jsxs)("div",{children:[(0,i.jsx)("p",{style:{margin:"5px 0",fontSize:"11px",fontWeight:"bold"},children:"\ud83c\udfad Test Emotions:"}),(0,i.jsx)("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"4px",marginBottom:"8px"},children:Object.keys(n.Xx).map((e=>(0,i.jsxs)("button",{onClick:()=>h(e),style:{background:"#555",color:"white",border:"1px solid rgba(255,255,255,0.2)",padding:"4px 6px",borderRadius:"3px",cursor:"pointer",fontSize:"10px",textTransform:"capitalize",transition:"background 0.2s"},onMouseEnter:e=>e.currentTarget.style.background="#777",onMouseLeave:e=>e.currentTarget.style.background="#555",children:[r(e)," ",e]},e)))}),(0,i.jsxs)("div",{style:{fontSize:"9px",opacity:.7,lineHeight:"1.2",borderTop:"1px solid rgba(255,255,255,0.1)",paddingTop:"6px"},children:[(0,i.jsx)("strong",{children:"\ud83c\udfaf Look for:"}),(0,i.jsx)("br",{}),"\u2022 ",(0,i.jsx)("strong",{children:"Joy:"})," Big smile + raised brows",(0,i.jsx)("br",{}),"\u2022 ",(0,i.jsx)("strong",{children:"Anger:"})," Furrowed brows + flared nostrils",(0,i.jsx)("br",{}),"\u2022 ",(0,i.jsx)("strong",{children:"Sad:"})," Frown + puppy dog eyes",(0,i.jsx)("br",{}),"\u2022 ",(0,i.jsx)("strong",{children:"Surprise:"})," Wide eyes + dramatic brows",(0,i.jsx)("br",{}),"\u2022 ",(0,i.jsx)("strong",{children:"Fear:"})," Wide eyes + worried brows",(0,i.jsx)("br",{}),"\u2022 ",(0,i.jsx)("strong",{children:"Disgust:"})," Nose sneer + lip curl"]})]}),l&&!u&&(0,i.jsx)("div",{style:{fontSize:"10px",opacity:.8,marginTop:"5px"},children:"Click \u25bc to expand controls"})]})};function r(e){return{happy:"\ud83d\ude0a",sad:"\ud83d\ude22",angry:"\ud83d\ude20",surprised:"\ud83d\ude32",scared:"\ud83d\ude28",disgusted:"\ud83e\udd22",confused:"\ud83d\ude15",content:"\ud83d\ude0c"}[e]||"\ud83d\ude10"}},67409:(e,o,t)=>{"use strict";t.d(o,{l:()=>i});var s=t(212);const n={joy:{mouthSmileLeft:1.2,mouthSmileRight:1.2,cheekSquintLeft:.8,cheekSquintRight:.8,eyeWideLeft:.3,eyeWideRight:.3,browOuterUpLeft:1,browOuterUpRight:1,cheekPuff:.2},sadness:{mouthFrownLeft:1.2,mouthFrownRight:1.2,browInnerUp:1,browDownLeft:.6,browDownRight:.6,eyeLookDownLeft:.4,eyeLookDownRight:.4,mouthLowerDownLeft:.5,mouthLowerDownRight:.5},anger:{browDownLeft:1.2,browDownRight:1.2,browInnerUp:.3,mouthPressLeft:.8,mouthPressRight:.8,eyeSquintLeft:.6,eyeSquintRight:.6,noseSneerLeft:.4,noseSneerRight:.4,mouthUpperUpLeft:.3,mouthUpperUpRight:.3},surprise:{jawOpen:.9,eyeWideLeft:1.2,eyeWideRight:1.2,browOuterUpLeft:1.2,browOuterUpRight:1.2,browInnerUp:.8,mouthFunnel:.3},fear:{mouthStretchLeft:.9,mouthStretchRight:.9,eyeWideLeft:1,eyeWideRight:1,browInnerUp:1,browOuterUpLeft:.7,browOuterUpRight:.7,jawOpen:.4},disgust:{noseSneerLeft:.8,noseSneerRight:.8,mouthUpperUpLeft:.7,mouthUpperUpRight:.7,eyeSquintLeft:.5,eyeSquintRight:.5,browDownLeft:.4,browDownRight:.4},contempt:{mouthSmileLeft:.2,mouthSmileRight:.7,eyeSquintLeft:.3,eyeSquintRight:.6,browDownLeft:.2,browDownRight:.5},excitement:{mouthSmileLeft:1,mouthSmileRight:1,eyeWideLeft:.8,eyeWideRight:.8,browOuterUpLeft:.9,browOuterUpRight:.9,cheekSquintLeft:.6,cheekSquintRight:.6,jawOpen:.3},contentment:{mouthSmileLeft:.4,mouthSmileRight:.4,eyeSquintLeft:.2,eyeSquintRight:.2,browOuterUpLeft:.2,browOuterUpRight:.2},confusion:{browDownLeft:.6,browOuterUpRight:.8,browInnerUp:.4,mouthPucker:.4,eyeSquintLeft:.3,jawOpen:.2},calm:{mouthSmileLeft:.15,mouthSmileRight:.15,eyeSquintLeft:.1,eyeSquintRight:.1},amusement:{mouthSmileLeft:.8,mouthSmileRight:.8,cheekSquintLeft:.7,cheekSquintRight:.7,browOuterUpLeft:.5,browOuterUpRight:.5},concentration:{browDownLeft:.5,browDownRight:.5,browInnerUp:.3,eyeSquintLeft:.4,eyeSquintRight:.4}},i=e=>{console.log("[prosodyToBlendshapes] Received prosodyScore keys:",Object.keys(e).join(", "));const o=s.a.reduce(((e,o)=>(e[o]=0,e)),{});console.log("[prosodyToBlendshapes] Processing emotions...");for(const[t,s]of Object.entries(e)){const e=n[t.toLowerCase()];if(e){console.log("[prosodyToBlendshapes] Processing emotion: ".concat(t,", Score: ").concat(s.toFixed(4)));for(const[t,n]of Object.entries(e)){const e=t,i=o[e]||0,a=s*n*7;o[e]=Math.min(1,Math.max(0,i+a))}}else console.log("[prosodyToBlendshapes] No weights found for emotion: ".concat(t,". Skipping."))}return console.log("[prosodyToBlendshapes] Final combined blendshapes count: ".concat(Object.keys(o).length,", sum of values: ").concat(Object.values(o).reduce(((e,o)=>e+o),0).toFixed(4))),o}},88632:()=>{}}]);